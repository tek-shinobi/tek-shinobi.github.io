<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Golang: Distributed Rate Limiting Using Fixed Window and Redis - Tek Shinobi Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Tek Shinobi Blog" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Tek Shinobi Blog</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Golang: Distributed Rate Limiting Using Fixed Window and Redis</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2023-07-25T10:41:57&#43;03:00">July 25, 2023</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/golang/" rel="category">golang</a>, <a class="meta__link" href="/categories/distributed-system-design/" rel="category">distributed system design</a>
	</span>
</div></div>
		</header>
		<div class="content post__content clearfix">
			<p>Fixed Window rate limiter is the simplest form of rate limiting. It means that once the expiration has been set, a client that reaches the limit will be blocked from making further requests until the expiration time arrives. If a client has a limit of 50 requests every minute and makes all 50 requests in the first 5 seconds of the minute, it will have to wait 55 seconds to make another request. This is also the main downside of this implementation, it would still let a client burn through its whole limit quickly (bursty traffic) and that could still overload your service, as it could be expecting this traffic to be spread out throughout the whole limiting period.</p>
<p>A good part with this approach is that since at the heart of it, it involves only one step, that of incrementing the counter, this strategy can be implemented in a distributed-system-safe way by just using an atomic counter.</p>
<blockquote>
<p>Atomic operations, pipelined commands and transactions are three different ways to make a distributed-system-safe rate limiter. Atomic operations are supported by nearly all in-momory cache solutions like Redis, Memcached etc. The latter two are not that widely supported. Redis is one that supports all three.</p>
</blockquote>
<blockquote>
<p>We will be using redis for implementing fixed window rate limiter.</p>
</blockquote>
<blockquote>
<p>Redis transactions and redis pipelined commands are two separate things. They are both designed to solve the same problem: making a bunch of operations run as a unit, without back and forth client-server hops and associated race-conditions. Redis transactions are like database transactions. Like you use SQL to write a database transaction, you use Lua scripts to write code that executes in a transaction on redis side. This code executes in an atomic way, i.e. its safe from data-races. This approach gives you the most flexibility with the downside of adding another language (Lua) to your stack. The other option is to you use Pipelined commands and then execute them in an atomic way using <code>Exec</code>. This is more restrictive approach but benefit is that you can implement it using Go without needing Lua. If you have more complex requirements, Lua script based transctions are the only way to go.</p>
</blockquote>
<p>We will use  <strong>Provider Pattern</strong> to implement our rate limiter.</p>
<p>Here is how our <code>ratelimiter.go</code> file looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ratelimiter</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>
)

<span style="color:#75715e">// Request defines a request that needs to be checked if it will be rate-limited or not.
</span><span style="color:#75715e">// The `Key` is the identifier you&#39;re using for the client making calls. This could be a user/account ID if the user is
</span><span style="color:#75715e">// signed into your application, the IP of the client making requests (this might not be reliable if you&#39;re not behind a
</span><span style="color:#75715e">// proxy like Cloudflare, as clients can try to spoof IPs). The `Key` should be the same for multiple calls of the
</span><span style="color:#75715e">// same client so we can correctly identify that this is the same app calling anywhere.
</span><span style="color:#75715e">// `Limit` is the number of requests the client is allowed to make over the `Duration` period. If you set this to
</span><span style="color:#75715e">// 100 and `Duration` to `1m` you&#39;d have at most 100 requests over a minute.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Request</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Key</span>      <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Limit</span>    <span style="color:#66d9ef">uint64</span>
	<span style="color:#a6e22e">Duration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
}

<span style="color:#75715e">// State is the result of evaluating the rate limit, either `Deny` or `Allow` a request.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">State</span> <span style="color:#66d9ef">int64</span>

<span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">Deny</span>  <span style="color:#a6e22e">State</span> = <span style="color:#ae81ff">0</span>
	<span style="color:#a6e22e">Allow</span>       = <span style="color:#ae81ff">1</span>
)

<span style="color:#75715e">// Result represents the response to a check if a client should be rate-limited or not. The `State` will be either
</span><span style="color:#75715e">// `Allow` or `Deny`, `TotalRequests` holds the number of requests this specific caller has already made over
</span><span style="color:#75715e">// the current period and `ExpiresAt` defines when the rate limit will expire/roll over for clients that
</span><span style="color:#75715e">// have gone over the limit.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Result</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">State</span>         <span style="color:#a6e22e">State</span>
	<span style="color:#a6e22e">TotalRequests</span> <span style="color:#66d9ef">uint64</span>
	<span style="color:#a6e22e">ExpiresAt</span>     <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Limiter</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>)
}

</code></pre></div><h3 id="attempt-1-write-first-implementation">Attempt 1: Write First implementation</h3>
<p>We will first implement via a <em><strong>write first</strong></em> approach. In this approach, we modify the redis counter first and then decide if this request will be allowed or denied. This makes the counter increment unbounded as any request will increment it even if it is rate limited. Its not optimal but its simpler to understand the logic. Later we will implement the optimized version with bounded increments.</p>
<p>this is how our <code>fixedwindow.go</code> looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ratelimiter</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>

	<span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
	<span style="color:#e6db74">&#34;github.com/redis/go-redis/v9&#34;</span>
)

<span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">keyWithoutExpire</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">fixedWindowLimiter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">redisClient</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Client</span>
	<span style="color:#a6e22e">now</span>         <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewFixedWindowLimiter</span>(<span style="color:#a6e22e">cl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">now</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) <span style="color:#a6e22e">Limiter</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">fixedWindowLimiter</span>{
		<span style="color:#a6e22e">redisClient</span>: <span style="color:#a6e22e">cl</span>,
		<span style="color:#a6e22e">now</span>:         <span style="color:#a6e22e">now</span>,
	}
}

<span style="color:#75715e">// Do ...
</span><span style="color:#75715e">// this implementation uses a simple counter with an expiration set to the rate limit duration.
</span><span style="color:#75715e">// This implementation is functional but not very effective if you have to deal with bursty traffic as
</span><span style="color:#75715e">// it will still allow a client to burn through its full limit quickly once the key expires.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">fixedWindowLimiter</span>) <span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#75715e">// a pipeline in Redis is a way to send multiple commands that will all be run together.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// this is not a transaction and there are many ways in which these commands could fail
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// (only the first, only the second) so we have to make sure all errors are handled,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// this is a network performance optimization.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">redisClient</span>.<span style="color:#a6e22e">Pipeline</span>()
	<span style="color:#a6e22e">incrResult</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Incr</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)
	<span style="color:#a6e22e">ttlResult</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">TTL</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed at exec pipeline with key: %s&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)
	}

	<span style="color:#a6e22e">totalRequests</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">incrResult</span>.<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to increment key: %s&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ttlDuration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>
	<span style="color:#75715e">// we want to make sure there is always an expiration set on the key, so on every
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// increment we check again to make sure it has a TTl and if it doesn&#39;t we add one.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// a duration of -1 means that the key has no expiration so we need to make sure there
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// is one set, this should, most of the time, happen when we increment for the
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// first time but there could be cases where we fail at the previous commands so we should
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// check for the TTL on every request.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dur</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ttlResult</span>.<span style="color:#a6e22e">Result</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">dur</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">keyWithoutExpire</span> {
		<span style="color:#a6e22e">ttlDuration</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Duration</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">redisClient</span>.<span style="color:#a6e22e">Expire</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Duration</span>).<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to set expiration to key: %s&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)
		}
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">ttlDuration</span> = <span style="color:#a6e22e">dur</span>
	}

	<span style="color:#a6e22e">expiresAt</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sl</span>.<span style="color:#a6e22e">now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">ttlDuration</span>)
	<span style="color:#a6e22e">requestCount</span> <span style="color:#f92672">:=</span> uint64(<span style="color:#a6e22e">totalRequests</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">requestCount</span> &gt; <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Limit</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Result</span>{
			<span style="color:#a6e22e">State</span>:         <span style="color:#a6e22e">Deny</span>,
			<span style="color:#a6e22e">TotalRequests</span>: <span style="color:#a6e22e">requestCount</span>,
			<span style="color:#a6e22e">ExpiresAt</span>:     <span style="color:#a6e22e">expiresAt</span>,
		}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Result</span>{
		<span style="color:#a6e22e">State</span>:         <span style="color:#a6e22e">Allow</span>,
		<span style="color:#a6e22e">TotalRequests</span>: <span style="color:#a6e22e">requestCount</span>,
		<span style="color:#a6e22e">ExpiresAt</span>:     <span style="color:#a6e22e">expiresAt</span>,
	}, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h3 id="attempt-2-bounded-increments-implementations">Attempt 2: Bounded Increments implementations</h3>
<p>Here is the final version with bounded increments. Now we read before we increment, making sure we only increment if this is a good request that will be allowed. Otherwise just bail and deny the request before trying anything.</p>
<p><code>fixedwindow.go</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">ratelimiter</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;context&#34;</span>
	<span style="color:#e6db74">&#34;time&#34;</span>

	<span style="color:#e6db74">&#34;github.com/pkg/errors&#34;</span>
	<span style="color:#e6db74">&#34;github.com/redis/go-redis/v9&#34;</span>
)

<span style="color:#66d9ef">const</span> (
	<span style="color:#a6e22e">keyThatDoesNotExist</span> = <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>
	<span style="color:#a6e22e">keyWithoutExpire</span>    = <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">fixedWindowLimiter</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">redisClient</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Client</span>
	<span style="color:#a6e22e">now</span>         <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewFixedWindowLimiter</span>(<span style="color:#a6e22e">cl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">now</span> <span style="color:#66d9ef">func</span>() <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>) <span style="color:#a6e22e">Limiter</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">fixedWindowLimiter</span>{
		<span style="color:#a6e22e">redisClient</span>: <span style="color:#a6e22e">cl</span>,
		<span style="color:#a6e22e">now</span>:         <span style="color:#a6e22e">now</span>,
	}
}

<span style="color:#75715e">// Do ...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fwl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">fixedWindowLimiter</span>) <span style="color:#a6e22e">Do</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fwl</span>.<span style="color:#a6e22e">redisClient</span>.<span style="color:#a6e22e">Pipeline</span>()
	<span style="color:#a6e22e">getResult</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)
	<span style="color:#a6e22e">ttlResult</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">TTL</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Exec</span>(<span style="color:#a6e22e">ctx</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Nil</span>) {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed at exec pipeline with key: %s&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ttlDuration</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>

	<span style="color:#a6e22e">dur</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ttlResult</span>.<span style="color:#a6e22e">Result</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">dur</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">keyWithoutExpire</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">dur</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">keyThatDoesNotExist</span> {
		<span style="color:#a6e22e">ttlDuration</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Duration</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fwl</span>.<span style="color:#a6e22e">redisClient</span>.<span style="color:#a6e22e">Expire</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Duration</span>).<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to set expiration to key: %s&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)
		}
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">ttlDuration</span> = <span style="color:#a6e22e">dur</span>
	}

	<span style="color:#a6e22e">expiresAt</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fwl</span>.<span style="color:#a6e22e">now</span>().<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">ttlDuration</span>)

	<span style="color:#a6e22e">requestCount</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">getResult</span>.<span style="color:#a6e22e">Uint64</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Nil</span>) {

	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">&amp;&amp;</span> !<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Nil</span>) {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrapf</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to get total request count for key:%s&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">requestCount</span> &gt; <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Limit</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Result</span>{
			<span style="color:#a6e22e">State</span>:         <span style="color:#a6e22e">Deny</span>,
			<span style="color:#a6e22e">TotalRequests</span>: <span style="color:#a6e22e">requestCount</span>,
			<span style="color:#a6e22e">ExpiresAt</span>:     <span style="color:#a6e22e">expiresAt</span>,
		}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#a6e22e">incrResult</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fwl</span>.<span style="color:#a6e22e">redisClient</span>.<span style="color:#a6e22e">Incr</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)
	<span style="color:#a6e22e">requestCount</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">incrResult</span>.<span style="color:#a6e22e">Uint64</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;failed to increment request count&#34;</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">requestCount</span> &gt; <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Limit</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Result</span>{
			<span style="color:#a6e22e">State</span>:         <span style="color:#a6e22e">Deny</span>,
			<span style="color:#a6e22e">TotalRequests</span>: <span style="color:#a6e22e">requestCount</span>,
			<span style="color:#a6e22e">ExpiresAt</span>:     <span style="color:#a6e22e">expiresAt</span>,
		}, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Result</span>{
		<span style="color:#a6e22e">State</span>:         <span style="color:#a6e22e">Allow</span>,
		<span style="color:#a6e22e">TotalRequests</span>: <span style="color:#a6e22e">requestCount</span>,
		<span style="color:#a6e22e">ExpiresAt</span>:     <span style="color:#a6e22e">expiresAt</span>,
	}, <span style="color:#66d9ef">nil</span>
}
</code></pre></div>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/golang/" rel="tag">golang</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/rate-limiter/" rel="tag">rate limiter</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/redis/" rel="tag">redis</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>




			</div>
			<aside class="sidebar">
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="LinkedIn" rel="noopener noreferrer" href="https://linkedin.com/in/himanshu-singh-remote/" target="_blank">
				<svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/tek-shinobi" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>

		
	</div>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/golangdistributed-rate-limiting-using-fixed-window/">Golang: Distributed Rate Limiting Using Fixed Window and Redis</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/rate-limiting-in-distributed-system/">Rate Limiting in a Distributed System</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/golang-testing-creating-large-files/">Golang Testing: Creating Large Files</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/add-gpg-keys-to-repo/">Add Gpg Keys to Repo</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/golang-handling-null-in-database-tables/">Golang: Handling Null in Database Tables</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/using-postgres-inside-docker-container/">Golang: Using Postgres Inside Docker Container</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/golang-common-concurrency-patterns/">Golang: Common Concurrency Patterns</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/golang-channels/">Golang Channels</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/golangcobra-and-viper-tutorial/">Golang:Cobra and Viper Tutorial</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/minikubecheatsheet/">Kubernetes tutorial &#43; Minikube:cheatsheet</a></li>
		</ul>
	</div>
</div>
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item">
				<a class="widget__link" href="/categories/backend/">backend</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/distributed-system-design/">distributed system design</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/docker/">docker</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/frontend/">frontend</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/github/">github</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/golang/">golang</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/javascript/">javascript</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/kubernetes/">kubernetes</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/networking/">networking</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/python/">python</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/rust/">rust</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/virtualbox/">Virtualbox</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/automation/" title="automation">automation</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/backend/" title="backend">backend</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/c#/" title="c#">c#</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/concurrency/" title="concurrency">concurrency</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/css/" title="css">css</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/django/" title="django">django</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/docker/" title="docker">docker</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/es6/" title="ES6">ES6</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/github/" title="github">github</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/golang/" title="golang">golang</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/gpg/" title="gpg">gpg</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/javascript/" title="javascript">javascript</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/minikube/" title="minikube">minikube</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/networking/" title="networking">networking</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/postgres/" title="postgres">postgres</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/python/" title="python">python</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/rate-limiter/" title="rate limiter">rate limiter</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/react/" title="react">react</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/redis/" title="redis">redis</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/rust/" title="rust">rust</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/scrapy/" title="scrapy">scrapy</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/tcp/" title="tcp">tcp</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/testing/" title="testing">testing</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/tools/" title="tools">tools</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/turbofish/" title="turbofish">turbofish</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/virtualbox/" title="virtualbox">virtualbox</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2023 Tek Shinobi Blog.
			
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>