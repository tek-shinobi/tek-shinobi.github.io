<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Backend Python:SqlAlchemy Tutorial - Tek Shinobi Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="Tek Shinobi Blog" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">Tek Shinobi Blog</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Backend Python:SqlAlchemy Tutorial</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2018-09-07T17:21:17&#43;03:00">September 07, 2018</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/backend/" rel="category">backend</a>, <a class="meta__link" href="/categories/python/" rel="category">python</a>
	</span>
</div></div>
		</header>
		<div class="content post__content clearfix">
			<p><figure><img src="/box-diag-sqla.jpg"
         alt="SQLAlchemy Overview"/><figcaption>
            <p>SQLAlchemy Overview</p>
        </figcaption>
</figure>

This describes the basic overview of SQL Alchemy. Notice the color theme. It will be related to the next onion-ring overview of SQL Alchemy.</p>
<figure><img src="/onion-diag-sqla.jpg"
         alt="SQLAlchemy Overview"/><figcaption>
            <p>SQLAlchemy Onion Diagram</p>
        </figcaption>
</figure>

<p>SQL Alchemy is divided into Core and ORM. You can use Core and not use ORM. ORM is more geared towards mapping model objects to Python data types. Core on the other hand focuses on transacting with the database.</p>
<h2 id="level-1-engine-connections-transactions">Level 1: Engine, Connections, Transactions</h2>
<p>This is the level that talks directly to Python DBAPI.</p>
<p>Engine
Engine is what creates and maintains connection to the database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(<span style="color:#e6db74">&#34;sqlite:///tutorial.db&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> engine<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;select 1&#34;</span>)
</span></span></code></pre></div><p>Here we first create an engine to talk to the database. Engine object is lazy in that the actual connection to the database is not created until the first execute command is run (or some other command that makes it to actually access database).</p>
<p>Here, the third line in the code will actually cause the database connection to be created and actually create a sqlite database named tutorial.db.</p>
<p>The result object also has methods like fetchone(), fetchall().
NOTE: engine.echo = True will enable logging to console. You will then be able to see all the SQL generated by SQLAlchemy when you run these in console.
If we do something like:
<code>row = result.fetchone()</code>
the row object can behave like a tuple :
<code>&gt;&gt;&gt;row</code>
<code>(5, u’hello’)</code>
but can also act like a dictionary:
<code>&gt;&gt;&gt;row['greeting_message']</code>
<code>u’hello’</code>
where ‘greeting_message’ is a column in the database table. i.e. columns in select query become dictionary keys.
<code>&gt;&gt;&gt;result.close()</code>
results object will close automatically when all rows are exhausted, but we can also close explicitly. results object contains the cursor object inside it, as well as the connection. The cursor object needs to be closed and connection needs to be returned to the pool of the connections to the database. result.close() does all this.</p>
<p>result object can also be iterated:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>result <span style="color:#f92672">=</span> engine<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;select * from employee&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> result:
</span></span><span style="display:flex;"><span>    print(row)
</span></span></code></pre></div><p>Note: We will create the toy database of employee in the context manager section</p>
<h2 id="connection-scoping">Connection Scoping</h2>
<p>We can control the scope of the connection using connect()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(<span style="color:#e6db74">&#34;sqlite:///tutorial.db&#34;</span>)
</span></span><span style="display:flex;"><span>conn <span style="color:#f92672">=</span> engine<span style="color:#f92672">.</span>connect()
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;select * from employee&#34;</span>)
</span></span><span style="display:flex;"><span>rows <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>fetchall()
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p>Note, conn is not the DBAPI connection object. It is a SQLAlchemy connection object that wraps the DBAPI connection object. The same way that the result object wraps the cursor object from DBAPI.</p>
<h2 id="transactions">Transactions</h2>
<p>To run several statements inside a transaction, Connection features a begin() method that returns a Transaction.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(<span style="color:#e6db74">&#34;sqlite:///tutorial.db&#34;</span>)
</span></span><span style="display:flex;"><span>conn <span style="color:#f92672">=</span> engine<span style="color:#f92672">.</span>connect()
</span></span><span style="display:flex;"><span>trans <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>begin()
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;insert into employee(emp_name) values (:emp_name)&#34;</span>, emp_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;wendy&#34;</span>)
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;select * from employee&#34;</span>)
</span></span><span style="display:flex;"><span>trans<span style="color:#f92672">.</span>commit()
</span></span><span style="display:flex;"><span>conn<span style="color:#f92672">.</span>close()
</span></span></code></pre></div><p>The transaction gets committed when commit() is called. Note that between begin() and commit(), we have executed multiple sql statements. If commit is not successful, they will be rolled back.</p>
<p>Note that if we don’t provide begin() and commit(), then SQL Alchemy will auto commit each insert, update, delete, select statement. So, the moment you say begin(), it turns off the auto-commit. Also, note that begin() does not exist in python DBAPI. DBAPI only has COMMIT and ROLLBACK. SQLAlchemy generates a BEGIN(implicit) where you say begin() just to give a visual indication that begin() was called here.</p>
<h2 id="context-manager">Context Manager</h2>
<p>We can use a context manager to streamline the process of being and commit.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(<span style="color:#e6db74">&#34;sqlite:///tutorial.db&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> engine<span style="color:#f92672">.</span>begin() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;create table employee (emp_id integer primary key, emp_name varchar(30))&#34;</span>)
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;insert into employee (emp_name) values (:emp_name)&#34;</span>, emp_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dilbert&#39;</span>)
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;insert into employee (emp_name) values (:emp_name)&#34;</span>, emp_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dingo&#39;</span>)
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;insert into employee (emp_name) values (:emp_name)&#34;</span>, emp_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;landy&#39;</span>)
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;insert into employee (emp_name) values (:emp_name)&#34;</span>, emp_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mango&#39;</span>)
</span></span><span style="display:flex;"><span>    conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;insert into employee (emp_name) values (:emp_name)&#34;</span>, emp_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;lilo&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> engine<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#34;select * from employee&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> result<span style="color:#f92672">.</span>fetchall():
</span></span><span style="display:flex;"><span>    print(row)
</span></span></code></pre></div><p>context manager takes care of committing. For the select statement, an autocommit happened.</p>
<h2 id="engine-facts">Engine Facts</h2>
<ul>
<li>Executing via the Engine directly is called connectionless execution – the Engine connects and disconnects for us.</li>
<li>Using a Connection is called explicit execution. We control the span of a connection in use.</li>
<li>Engine usually uses a connection pool, which means “disconnecting” often means the connection is just returned to the pool.</li>
<li>The SQL we send to engine.execute () as a string is not modified, is consumed by the DBAPI verbatim.</li>
</ul>
<h2 id="level-2-table-metadata-reflection-ddl">Level 2: Table Metadata, Reflection, DDL</h2>
<h3 id="ddl">DDL</h3>
<p>DDL stands for Create, drop, alter table (among other things). This is a sql subset of commands. DDL is the language that we use to alter the schema of the database.
Describes the structure of the database, i.e. tables, columns, constraints, in terms of data structures in Python</p>
<h3 id="metadata">Metadata</h3>
<ul>
<li>Serves as the basis for SQL generation and object relational mapping. This is a python object that closely mirrors the database object.</li>
<li>Can generate to a schema i.e. we can use metadate to generate a create table statement, or drop table statement or alter table statement. It will do so based on the info it has.</li>
<li>Can be generated from a schema i.e. we can generate metadata from a sql schema (like create table statement can be used to generate metadata). This is called Reflection. If you have an existing database, you can just connect SQLAlchemy to this databse and it will generate all the python objects representing the database.</li>
</ul>
<h3 id="schema-and-metadata">Schema and MetaData</h3>
<p>The structure of a relational schema is represented in Python using MetaData, Table and other objects.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>metadata <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>MetaData()
</span></span><span style="display:flex;"><span>user_table <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;user&#39;</span>, metadata,
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;fullname&#39;</span>, sa<span style="color:#f92672">.</span>String)
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Here, we created a metadata for a table. Most of the time, metadata is just an container for tables. And does nothing else.</p>
<p>Also, there is no connection to the database. So <strong>user_table</strong> is just a python object, created from Table class in sqlalchemy, at this time. We just constructed this table and gave it 5 arguments. The first argument is the name of the table. The second argument is the metadata (the container in which this table exists). Note: every table we create that has this “metadata” will populate itself as a collection of tables that has this metadata. A table of a given name can only exist once within that metadata object. And we can make tables that refer to each-other using foreign key constraints by name. And metadata serves as a construct so we lookup those tables by name. Metadata is also a place where we can commit commands like create all tables, drop all tables.</p>
<p>So, the python Table is represented as a Table object, Column object is represented as Column here. Each column has a name. You should also give each column a datatype. On the database, String is VARCHAR. Nothing has happened with the database yet. This is just a Python object.</p>
<p>Table provides a single point of information regarding the structure of a table in a schema. So, we can check what the name of table is:
<code>&gt;&gt;&gt;user_table.name</code>
There is a .c attribute of Table which is an associative array of Columns objects (its not an array but like a dictionary), keyed on name. Here I think c is short for collection or container of column objects. c is like a collection object. It acts like a dictionary, but is not a dictionary.
<code>&gt;&gt;&gt;user_table.c.name</code>
<code>Output:&gt;&gt;&gt;Column('name', String(), table=user)</code></p>
<p>If you do:
<code>&gt;&gt;&gt;user_table.c.keys()</code>
you will get the list of all column names in this table object.</p>
<p>The Column object itself has info about column like name and type.
<code>&gt;&gt;&gt;user_table.c.id.name</code>
<code>Output:&gt;&gt;&gt;'id'</code>
<code>&gt;&gt;&gt;user_table.c.id.type</code>
<code>Output:&gt;&gt;&gt;String()</code></p>
<p>Table has other information available, such as collection of columns which comprise the table’s primary key.
<code>&gt;&gt;&gt;user_table.primary_key</code></p>
<p>The Table object is at the core of the SQL expression system.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>user_table.select<span style="color:#f92672">())</span>
</span></span><span style="display:flex;"><span>SELECT <span style="color:#e6db74">&#34;user&#34;</span>.id, <span style="color:#e6db74">&#34;user&#34;</span>.name, <span style="color:#e6db74">&#34;user&#34;</span>.fullname 
</span></span><span style="display:flex;"><span>FROM <span style="color:#e6db74">&#34;user&#34;</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>user_table.select<span style="color:#f92672">()</span>.where<span style="color:#f92672">(</span>user_table.c.fullname<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;asdf&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>SELECT <span style="color:#e6db74">&#34;user&#34;</span>.id, <span style="color:#e6db74">&#34;user&#34;</span>.name, <span style="color:#e6db74">&#34;user&#34;</span>.fullname 
</span></span><span style="display:flex;"><span>FROM <span style="color:#e6db74">&#34;user&#34;</span> 
</span></span><span style="display:flex;"><span>WHERE <span style="color:#e6db74">&#34;user&#34;</span>.fullname <span style="color:#f92672">=</span> :fullname_1
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>You can already see how SQL expressions are generated from Table metadata.</p>
<p>So, now lets create a whole table from metadata we wrote above.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; metadata.create_all<span style="color:#f92672">(</span>engine<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-15 19:00:54,109 INFO sqlalchemy.engine.base.Engine PRAGMA main.table_info<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-15 19:00:54,109 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-15 19:00:54,110 INFO sqlalchemy.engine.base.Engine PRAGMA temp.table_info<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-15 19:00:54,110 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-15 19:00:54,112 INFO sqlalchemy.engine.base.Engine 
</span></span><span style="display:flex;"><span>CREATE TABLE user <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        id INTEGER NOT NULL, 
</span></span><span style="display:flex;"><span>        name VARCHAR, 
</span></span><span style="display:flex;"><span>        fullname VARCHAR, 
</span></span><span style="display:flex;"><span>        PRIMARY KEY <span style="color:#f92672">(</span>id<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2020-04-15 19:00:54,113 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-15 19:00:54,248 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>This time, we actually created a table schema and committed to sqlite. sqlalchemy always generates COMMIT after every transaction. If the metadata had more tables, they would all have been created as one transaction. This way, if there is a problem anywhere, while creating all tables and inserting data to them, then everything will get rolled back and no commit will happen.</p>
<p>Lets create another table with some different data-types in columns:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(<span style="color:#e6db74">&#34;sqlite:///tutorial.db&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>metadata <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>MetaData()
</span></span><span style="display:flex;"><span>table_1 <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;table_1&#39;</span>, metadata,
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;timestamp&#39;</span>, sa<span style="color:#f92672">.</span>DateTime),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;amount&#39;</span>, sa<span style="color:#f92672">.</span>Numeric(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">2</span>)),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;type&#39;</span>, sa<span style="color:#f92672">.</span>Enum(<span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;c&#39;</span>))
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>table_1<span style="color:#f92672">.</span>create(engine)
</span></span></code></pre></div><p>the create will generate this SQL and commit it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>SQL: 
</span></span><span style="display:flex;"><span>CREATE TABLE table_1 <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        id INTEGER NOT NULL, 
</span></span><span style="display:flex;"><span>        name VARCHAR, 
</span></span><span style="display:flex;"><span>        timestamp DATETIME, 
</span></span><span style="display:flex;"><span>        amount NUMERIC<span style="color:#f92672">(</span>10, 2<span style="color:#f92672">)</span>, 
</span></span><span style="display:flex;"><span>        type VARCHAR<span style="color:#f92672">(</span>1<span style="color:#f92672">)</span>, 
</span></span><span style="display:flex;"><span>        PRIMARY KEY <span style="color:#f92672">(</span>id<span style="color:#f92672">)</span>, 
</span></span><span style="display:flex;"><span>        CHECK <span style="color:#f92672">(</span>type IN <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;c&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Let us now make another table with a foreign key constraint.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>user_details <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;user_details&#39;</span>, metadata,
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;email&#39;</span>, sa<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">100</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;user_id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, sa<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#39;user.id&#39;</span>)),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Note: This is how you create a table with one foreign key. If you have composite foreign keys, its slightly different.</p>
<p>One interesting thing to note here is that in actual SQL, we would be creating the user table first before creating any other table that has a foreign key constraint to it. In sqlalchemy, so long as all tables exist in the metadata, it does not matter in which order they occur. The user table and the user_details table just need to be present in the metadata. The order in which they were added to the metadata does not matter.</p>
<p>Now let’s look at an example of composite primary key. Composite primary key is when there are multiple columns in a table that are primary keys.
Note: ForeignKey is shortcut for ForeignKeyContraint, which should be used for composite references.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>metadata <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>MetaData()
</span></span><span style="display:flex;"><span>story_table <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;story&#39;</span>, metadata,
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;story_id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;version_id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;title&#39;</span>, sa<span style="color:#f92672">.</span>Unicode(<span style="color:#ae81ff">100</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;body&#39;</span>, sa<span style="color:#f92672">.</span>UnicodeText),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>published_table<span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;published&#39;</span>, metadata,
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;pub_id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;pub_timestamp&#39;</span>, sa<span style="color:#f92672">.</span>DateTime nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;story_id&#39;</span>, sa<span style="color:#f92672">.</span>Integer),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;version_id&#39;</span>, sa<span style="color:#f92672">.</span>Integer),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>ForeignKeyConstraint(
</span></span><span style="display:flex;"><span>                    [<span style="color:#e6db74">&#39;story_id&#39;</span>, <span style="color:#e6db74">&#39;version_id&#39;</span>],
</span></span><span style="display:flex;"><span>                    [<span style="color:#e6db74">&#39;story.story_id&#39;</span>, <span style="color:#e6db74">&#39;story.version_id&#39;</span>]
</span></span><span style="display:flex;"><span>                ),
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>Note: In ForeignKeyConstraint field, we didn’t add a type. SqlAlchemy is now able to infer the type from the field it is referring to.
Note: here, if you do metadata.create_all(), it will check which tables in the metadata already exist in the database and skip those and only create schema and commit for those that don’t exist.</p>
<h3 id="reflection">Reflection</h3>
<p>Reflection refers to loading Table objects based on reading from an existing database.
This is how we do it. Remember we have already created a table called ‘user’.</p>
<p><code>&gt;&gt;&gt; metadata_new = sa.MetaData()</code>
<code>&gt;&gt;&gt; user_reflected = sa.Table('user', metadata_new, autoload=True, autoload_with=engine)</code>
metadata_new is an empty metadata. We now do reflection, and load an empty Table object with reflected data from database for table ‘user’</p>
<p>user_reflected now has all the schema information related to ‘user’ in the database. This is a very powerful feature of sqlalchemy.</p>
<h3 id="inspector">Inspector</h3>
<p>Information about a database at a more specific level is available using the inspector object. What you saw before in Reflection, Inspector gives you the same ability with many more convenience methods.</p>
<p><code>&gt;&gt;&gt;from sqlalchemy import inspect</code>
<code>&gt;&gt;&gt;inspector = inspect(engine)</code></p>
<p>Noe, the inspector object can be queried to do reflection on all types of stuff in the database. Here inpector is an object that is specific to engines and knows how to reflect them.</p>
<p>For example inspector can give you the names of the all the tables in the database like so:
<code>&gt;&gt;&gt;inspector.get_table_names()</code></p>
<p>Inspector object will give you all the columns of a table if you give it a table name.
<code>&gt;&gt;&gt;inspector.get_columns('user')</code></p>
<p>Inspector object will give you all the foreign keys of a table if you give it a table name.
<code>&gt;&gt;&gt;inspector.get_foreign_keys('published')</code></p>
<h3 id="basic-types">Basic Types</h3>
<ul>
<li>Integer () – basic integer type, generates INT</li>
<li>String () – ASCII strings, generates VARCHAR</li>
<li>Unicode () – Unicode strings – generates VARCHAR, NVARCHAR depending on database</li>
<li>Boolean () – generates BOOLEAN, INT, TINYINT</li>
<li>DateTime () – generates DATETIME or TIMESTAMP, returns Python datetime () objects</li>
<li>Float () – floating point values</li>
<li>Numeric () – precision numerics using Python Decimal()</li>
</ul>
<h3 id="create-and-drop">CREATE and DROP</h3>
<p>Here are different ways to issue create and drops</p>
<ul>
<li>metadata.create_all (engine, checkfirst = ) emits CREATE statements for all tables.</li>
<li>table.create (engine, checkfirst = ) emits CREATE for a single table.</li>
<li>metadata.drop_all (engine, checkfirst = ) emits DROP statements for all tables.</li>
<li>table.drop (engine, checkfirst = ) emits DROP for a single table.</li>
</ul>
<h2 id="level-3-sql-expressions">Level 3: SQL Expressions</h2>
<ul>
<li>The SQL Expression system builds upon Table Metadata in order to compose SQL statements in Python.</li>
<li>We will build Python objects that represent individual SQL strings (statements) we’d send to the database.</li>
<li>These objects are composed of other objects that each represent some unit of SQL, like a comparison, a SELECT statement, a conjunction such as AND or OR.</li>
<li>We work with these objects in Python, which are then converted to strings when we “execute” them (as well as if we print them).</li>
</ul>
<h3 id="tables">Tables</h3>
<p>Let’s start with tables. We will first create a table using metadata and then we will start building SQL Expressions (you’ll be mostly dealing with DML in these SQL Expressions.. as in select, insert, update).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(<span style="color:#e6db74">&#34;sqlite:///tutorial.db&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>metadata <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>MetaData()
</span></span><span style="display:flex;"><span>user_table <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;user&#39;</span>, metadata,
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">50</span>)),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;fullname&#39;</span>, sa<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">50</span>))
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>metadata<span style="color:#f92672">.</span>create_all(engine)
</span></span></code></pre></div><p>Note: If the table already exists, metadata will not generate the create table sql schema. But there will be no error.</p>
<p>As we saw before, we can access the collection of all columns in the table via the .c attribute. Individual columns can be accessed as
<code>.c. &gt;&gt;&gt;user_table.c.fullname</code>
Output:
<code>Column(‘fullname’, String(length=50), table=)</code></p>
<p>The “Column” object you see in the output is part of a class known as ColumnElement, which exhibits custom Python expression behavior. Meaning Column is a subclass of ColumnElement and inherits some custom Python expression behavior as we will see below.</p>
<p>What this means is that Column object will have a bunch of python magic methods like <code>__eq__</code>, <code>__lt__</code>, <code>__gt__</code> . These methods give us the ability to overload operators.</p>
<p>The trick thing to note here is this:A statement like <code>user_table.c.fullname == 'john galt'</code> when executed, does not return a bool but an expression object like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; user_table.c.fullname <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john galt&#39;</span>
</span></span><span style="display:flex;"><span>&lt;sqlalchemy.sql.elements.BinaryExpression object at 0x7fa5339ea160&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>These expression objects become SQL when evaluated as a string.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; str<span style="color:#f92672">(</span>user_table.c.fullname <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#34;user&#34;.fullname = :fullname_1&#39;</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Here, you can see the generated SQL. In it, the string ‘john galt’ has vanished and replaced by a bound parameter :fullname_1</p>
<p>The ‘john galt’ string is still there, you just can’t see it.</p>
<p>ColumnElements are the basic building blocks of SQL Expressions. ColumnElements can be further combined to produce more ColumnElements.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>metadata <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>MetaData()
</span></span><span style="display:flex;"><span>user_table <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(<span style="color:#e6db74">&#39;user&#39;</span>, metadata,
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;name&#39;</span>, sa<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">50</span>)),
</span></span><span style="display:flex;"><span>                sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;fullname&#39;</span>, sa<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">50</span>))
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>for example, for the above code, we use a python bitwise OR operator to generate an SQL expression with OR</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span><span style="color:#f92672">)</span> | <span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;galt&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.name <span style="color:#f92672">=</span> :name_1 OR <span style="color:#e6db74">&#34;user&#34;</span>.name <span style="color:#f92672">=</span> :name_2
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>OR and AND are available with |, &amp;, or or_() and and_()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; import sqlalchemy as sa
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>... sa.and_<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>...     user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span>,
</span></span><span style="display:flex;"><span>...             sa.or_<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>...                     user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;jong&#39;</span>,
</span></span><span style="display:flex;"><span>...                     user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;jing&#39;</span>
</span></span><span style="display:flex;"><span>...             <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>...     <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.name <span style="color:#f92672">=</span> :name_1 AND <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user&#34;</span>.name <span style="color:#f92672">=</span> :name_2 OR <span style="color:#e6db74">&#34;user&#34;</span>.name <span style="color:#f92672">=</span> :name_3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Compare to None produces IS NULL</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> None<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.name IS NULL
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>“+” meaning vaies with context. If used with integers, it will add, with strings it will concatenate</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>user_table.c.id + 5<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.id + :id_1
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>user_table.c.fullname + <span style="color:#e6db74">&#39;galt&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.fullname <span style="color:#f92672">||</span> :fullname_1
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>To generate IN:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>user_table.c.fullname.in_<span style="color:#f92672">([</span><span style="color:#e6db74">&#39;ping&#39;</span>,<span style="color:#e6db74">&#39;pong&#39;</span>,<span style="color:#e6db74">&#39;ding&#39;</span>,<span style="color:#e6db74">&#39;dong&#39;</span><span style="color:#f92672">]))</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.fullname IN <span style="color:#f92672">(</span>:fullname_1, :fullname_2, :fullname_3, :fullname_4<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><h3 id="bound-parameters-in-sql-expressions">bound parameters in SQL Expressions</h3>
<p>The “bound” parameters take place of the literal values, which are stored away for use when the statement is executed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; str<span style="color:#f92672">(</span>user_table.c.fullname <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#34;user&#34;.fullname = :fullname_1&#39;</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>The values of our “bound” parameters are still there, however, stored away within a structure called “compiled” object.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; expression <span style="color:#f92672">=</span> user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; compiled <span style="color:#f92672">=</span> expression.compile<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; compiled.params
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#39;name_1&#39;</span>: <span style="color:#e6db74">&#39;john&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>So, when we execute an SQL expression, the bound parameters are extracted. On execution, it goes through the process of compiling the expression and extracting the params.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; engine.execute<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>... user_table.select<span style="color:#f92672">()</span>.where<span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 14:05:15,058 INFO sqlalchemy.engine.base.Engine SELECT user.id, user.name, user.fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.name <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-16 14:05:15,058 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john&#39;</span>,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&lt;sqlalchemy.engine.result.ResultProxy object at 0x7fb67b9b0d90&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>SQL Expressions produce different strings according to dialect objects. Sqlalchemy can take multiple objects, like below is a comparison between default sqlite dialect (called qmark) and postgresql dialect</p>
<p>postgresql dialect:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; from sqlalchemy.dialects import postgresql
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>expression.compile<span style="color:#f92672">(</span>dialect<span style="color:#f92672">=</span>postgresql.dialect<span style="color:#f92672">()))</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.name <span style="color:#f92672">=</span> %<span style="color:#f92672">(</span>name_1<span style="color:#f92672">)</span>s
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>sqlite dialect:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; str<span style="color:#f92672">(</span>user_table.c.fullname <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#34;user&#34;.name = :name_1&#39;</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>same bound parameter in prostgres dialect is %(name_1)s and is :name_1 in sqlite dialect.</p>
<p>Some more examples:
user.fullname == ‘john’ AND user.id &gt; 5</p>
<p>user.fullname == ‘john’ OR (user.fullname == ‘john’ AND user.id &gt; 5)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>sa.and_<span style="color:#f92672">(</span>user_table.c.fullname <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span>, user_table.c.id &gt; 5<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.fullname <span style="color:#f92672">=</span> :fullname_1 AND <span style="color:#e6db74">&#34;user&#34;</span>.id &gt; :id_1
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>sa.or_<span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span><span style="color:#f92672">)</span>,sa.and_<span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ting&#39;</span>, user_table.c.id&gt;5<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.name <span style="color:#f92672">=</span> :name_1 <span style="color:#e6db74">&#34;user&#34;</span>.name <span style="color:#f92672">=</span> :name_1 AND <span style="color:#e6db74">&#34;user&#34;</span>.id &gt; :id_1
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><h3 id="dml-statements-insert">DML statements: insert</h3>
<p>We can do an insert into a table like so. We create the SQL expression with insert object. We then modify the insert object to add values. Then create the connection object because we want to use explicit execution. Then execute the SQL expression.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; insert_stmt <span style="color:#f92672">=</span> user_table.insert<span style="color:#f92672">()</span>.values<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;john&#39;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; conn <span style="color:#f92672">=</span> engine.connect<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; result <span style="color:#f92672">=</span> conn.execute<span style="color:#f92672">(</span>insert_stmt<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 14:32:49,744 INFO sqlalchemy.engine.base.Engine INSERT INTO user <span style="color:#f92672">(</span>name, fullname<span style="color:#f92672">)</span> VALUES <span style="color:#f92672">(</span>?, ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 14:32:49,745 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john&#39;</span>, <span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 14:32:49,746 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Also, note that because we didn’t say begin() and commit(), an autocommit happened.</p>
<p>insert and other DML can run multiple parameters at once.</p>
<p>For example, lets insert multiple values:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; conn.execute<span style="color:#f92672">(</span>user_table.insert<span style="color:#f92672">()</span>,<span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">{</span><span style="color:#e6db74">&#39;name&#39;</span>:<span style="color:#e6db74">&#39;ding&#39;</span>, <span style="color:#e6db74">&#39;fullname&#39;</span>:<span style="color:#e6db74">&#39;ding dong&#39;</span><span style="color:#f92672">}</span>,
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">{</span><span style="color:#e6db74">&#39;name&#39;</span>:<span style="color:#e6db74">&#39;bing&#39;</span>, <span style="color:#e6db74">&#39;fullname&#39;</span>:<span style="color:#e6db74">&#39;bing bong&#39;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>2020-04-16 16:03:34,095 INFO sqlalchemy.engine.base.Engine INSERT INTO user <span style="color:#f92672">(</span>name, fullname<span style="color:#f92672">)</span> VALUES <span style="color:#f92672">(</span>?, ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 16:03:34,095 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">((</span><span style="color:#e6db74">&#39;ding&#39;</span>, <span style="color:#e6db74">&#39;ding dong&#39;</span><span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;bing&#39;</span>, <span style="color:#e6db74">&#39;bing bong&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>2020-04-16 16:03:34,095 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span style="display:flex;"><span>&lt;sqlalchemy.engine.result.ResultProxy object at 0x7fb67b3208b0&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><h3 id="dml-statements-select">DML statements: select</h3>
<p>select() is used to produce any SELECT statement</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; select_stmt <span style="color:#f92672">=</span> sa.select<span style="color:#f92672">([</span>user_table.c.name, user_table.c.fullname<span style="color:#f92672">])</span>.where<span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; result <span style="color:#f92672">=</span> conn.execute<span style="color:#f92672">(</span>select_stmt<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 16:33:06,284 INFO sqlalchemy.engine.base.Engine SELECT user.name, user.fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.name <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-16 16:33:06,284 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john&#39;</span>,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> row in result:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>row<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john&#39;</span>, <span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>You can also say user_table.select() and it will do the same thing as above.
To select all columns from a table</p>
<p>Notice that in this case, sqlalchemy does not use select(*) but just select with table name inside. By default, sqlalchemy fetches all columns, unless specific columns are specified.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; select_stmt <span style="color:#f92672">=</span> sa.select<span style="color:#f92672">([</span>user_table<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; conn.execute<span style="color:#f92672">(</span>select_stmt<span style="color:#f92672">)</span>.fetchall<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-16 16:41:25,450 INFO sqlalchemy.engine.base.Engine SELECT user.id, user.name, user.fullname 
</span></span><span style="display:flex;"><span>FROM user
</span></span><span style="display:flex;"><span>2020-04-16 16:41:25,450 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[(</span>1, <span style="color:#e6db74">&#39;john&#39;</span>, <span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>2, <span style="color:#e6db74">&#39;ding&#39;</span>, <span style="color:#e6db74">&#39;ding dong&#39;</span><span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>3, <span style="color:#e6db74">&#39;bing&#39;</span>, <span style="color:#e6db74">&#39;bing bong&#39;</span><span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>A more complex select query:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; select_stmt <span style="color:#f92672">=</span> sa.select<span style="color:#f92672">([</span>user_table.c.name, user_table.c.fullname<span style="color:#f92672">])</span>.where<span style="color:#f92672">(</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>... sa.or_<span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span>, user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;galt&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; conn.execute<span style="color:#f92672">(</span>select_stmt<span style="color:#f92672">)</span>.fetchall<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-16 16:49:02,977 INFO sqlalchemy.engine.base.Engine SELECT user.name, user.fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.name <span style="color:#f92672">=</span> ? OR user.name <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-16 16:49:02,977 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john&#39;</span>, <span style="color:#e6db74">&#39;galt&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[(</span><span style="color:#e6db74">&#39;john&#39;</span>, <span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>If we use WHERE multiple times, it will be joined by AND</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; select_stmt <span style="color:#f92672">=</span> sa.select<span style="color:#f92672">([</span>user_table.c.name, user_table.c.fullname<span style="color:#f92672">])</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>... .where<span style="color:#f92672">(</span>sa.or_<span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span>, user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;galt&#39;</span><span style="color:#f92672">))</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>... .where<span style="color:#f92672">(</span>sa.or_<span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;john&#39;</span>, user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;doe&#39;</span><span style="color:#f92672">))</span><span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>... .where<span style="color:#f92672">(</span>sa.or_<span style="color:#f92672">(</span>user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;ding&#39;</span>, user_table.c.name <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;rambo&#39;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; conn.execute<span style="color:#f92672">(</span>select_stmt<span style="color:#f92672">)</span>.fetchall<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-16 16:55:19,988 INFO sqlalchemy.engine.base.Engine SELECT user.name, user.fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE <span style="color:#f92672">(</span>user.name <span style="color:#f92672">=</span> ? OR user.name <span style="color:#f92672">=</span> ?<span style="color:#f92672">)</span> AND <span style="color:#f92672">(</span>user.name <span style="color:#f92672">=</span> ? OR user.name <span style="color:#f92672">=</span> ?<span style="color:#f92672">)</span> AND <span style="color:#f92672">(</span>user.name <span style="color:#f92672">=</span> ? OR user.name <span style="color:#f92672">=</span> ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 16:55:19,988 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john&#39;</span>, <span style="color:#e6db74">&#39;galt&#39;</span>, <span style="color:#e6db74">&#39;john&#39;</span>, <span style="color:#e6db74">&#39;doe&#39;</span>, <span style="color:#e6db74">&#39;ding&#39;</span>, <span style="color:#e6db74">&#39;rambo&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>above the additional where clauses are added using method chaining but for some weird reason method chaining is referred to as “generative” in documentation for sqlalchemy.</p>
<h3 id="dml-statements-update">DML Statements: UPDATE</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; update_stmt <span style="color:#f92672">=</span> user_table.update<span style="color:#f92672">()</span>.values<span style="color:#f92672">(</span>fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bing bing&#39;</span><span style="color:#f92672">)</span>.where<span style="color:#f92672">(</span>user_table.c.name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;bing&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; conn.execute<span style="color:#f92672">(</span>update_stmt<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 17:08:41,100 INFO sqlalchemy.engine.base.Engine UPDATE user SET fullname<span style="color:#f92672">=</span>? WHERE user.name <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-16 17:08:41,100 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;bing bing&#39;</span>, <span style="color:#e6db74">&#39;bing&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 17:08:41,101 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span style="display:flex;"><span>&lt;sqlalchemy.engine.result.ResultProxy object at 0x7fb67b9b09a0&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>The only difference from SQL here is that in SQL Expression, update() is used with values() whereas in actual SQL, UPDATE is used with SET</p>
<p>Note: if you write something like r = conn.execute(update_stmt), then you can also do this r.rowcount to get a row-count of how many rows got modified with that update.
UPDATE can also use expressions based on other columns</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; update_stmt <span style="color:#f92672">=</span> user_table.update<span style="color:#f92672">()</span>.values<span style="color:#f92672">(</span>fullname<span style="color:#f92672">=</span>user_table.c.name + <span style="color:#e6db74">&#39; &#39;</span> + user_table.c.fullname<span style="color:#f92672">)</span>.where<span style="color:#f92672">(</span>user_table.c.name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;bing&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; conn.execute<span style="color:#f92672">(</span>update_stmt<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 17:25:16,919 INFO sqlalchemy.engine.base.Engine UPDATE user SET fullname<span style="color:#f92672">=(</span>user.name <span style="color:#f92672">||</span> ? <span style="color:#f92672">||</span> user.fullname<span style="color:#f92672">)</span> WHERE user.name <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-16 17:25:16,919 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39; &#39;</span>, <span style="color:#e6db74">&#39;bing&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 17:25:16,920 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span style="display:flex;"><span>&lt;sqlalchemy.engine.result.ResultProxy object at 0x7fb67b320e80&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>that ? you see is because of the space in the concatenation. Any literal becomes a bound parameter. (? is as in sqlite dialect. It will be different if using postgres dialect)</p>
<h3 id="dml-statements-delete">DML Statements: Delete</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; delete_stmt <span style="color:#f92672">=</span> user_table.delete<span style="color:#f92672">()</span>.where<span style="color:#f92672">(</span>user_table.c.name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;bing&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; conn.execute<span style="color:#f92672">(</span>delete_stmt<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 17:29:23,716 INFO sqlalchemy.engine.base.Engine DELETE FROM user WHERE user.name <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-16 17:29:23,716 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;bing&#39;</span>,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-16 17:29:23,717 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span style="display:flex;"><span>&lt;sqlalchemy.engine.result.ResultProxy object at 0x7fb67b320820&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><h2 id="level-4-object-relational-mapping">Level 4: Object Relational Mapping</h2>
<p>Object Relational Mapping or ORM is the process of associating object oriented classes with database tables. Till the SQLAlchemy core level, the data fetched from database is still in the form of tuples. What ORM usually does is convert this into a domain object. In contrast to the SQL Expression language, which presents a schema-centric view of data, SQLAlchemy-ORM presents a domain-model centric view of data.</p>
<p>The set of object oriented classes is referred to as the domain model.
<figure><img src="/what_does_an_orm_do_0.jpg"
         alt="What does an orm do"/>
</figure>

<figure><img src="/what_does_an_orm_do_1.jpg"
         alt="What does an orm do"/>
</figure>

<figure><img src="/what_does_an_orm_do_2-1.jpg"
         alt="What does an orm do"/>
</figure>
</p>
<p><strong>Other things ORMs do</strong>:</p>
<ul>
<li>provide a means of querying the database in terms of the domain model structure</li>
<li>Some can represent class inheritance hierarchies using a variety of schemes</li>
<li>Some can handle “sharding” of data, i.e. storing a domain model across multiple schemas or databases</li>
<li>Provide various patterns for concurrency, including row versioning</li>
<li>Provide patterns for data validation and coercion</li>
</ul>
<p>There are two flavors of ORMs. One like Django, which is an Active Record pattern. It has a .save() method in the domain object that will take care of persisting the data to the database(by creating the data). When you wish to update, you again call .save() and this will now do an update.</p>
<p>SQLAlchemy follows Data Record pattern. Here, persistence and domain objects are kept separate. What this means is that domain objects do not have a .save() method. Instead, there is as session object. You add the domain objects to the session and this takes care of persistence. This is also a unit of work pattern. Java hibernate follows the same pattern as sqlalchemy.</p>
<figure><img src="/flavor_of_orm.jpg"
         alt="Flavor of orm"/>
</figure>

<h3 id="key-orm-patterns">Key ORM Patterns</h3>
<ul>
<li>Unit of Work – objects are maintained by a system that tracks changes over the course of a transaction, and flushes pending changes periodically, in a transparent or semitransparent manner</li>
<li>Identity Map – objects are tracked by their primary key within the unit of work, and are kept unique on that primary key identity.</li>
<li>Lazy Loading – Some attributes of an object may emit additional SQL queries when they are accessed.</li>
<li>Eager Loading – Multiple tables are queried at once in order to load related objects and collections.</li>
<li>Method Chaining – queries are composed using a string of method calls which each return a new query object.</li>
</ul>
<h3 id="declarative">Declarative</h3>
<p>The declarative system is normally used to configure object relational mappings.
You use the Base as the base class using which you build your domain class. Something like models.Model in Django. The only difference is that models.Model is a class. But in sqlalchemy, you create a base class object by calling a function declarative_base.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.ext.declarative <span style="color:#f92672">import</span> declarative_base
</span></span><span style="display:flex;"><span>Base <span style="color:#f92672">=</span> declarative_base()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(Base):
</span></span><span style="display:flex;"><span>    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;user&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Column(sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Column(sa<span style="color:#f92672">.</span>String)
</span></span><span style="display:flex;"><span>    fullname <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Column(sa<span style="color:#f92672">.</span>String)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __str__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&lt;User(</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>fullname<span style="color:#e6db74">}</span><span style="color:#e6db74">)&gt;&#39;</span>
</span></span></code></pre></div><p>This seems to resemble the user table we have in the database. But this is just a class. Because it inherits from Base, and has the attribute <code>__tablename__</code> set, when this class is executed, because of underlying metaclasses, Table object (the SQL Alchemy core Table) gets created internally. You can see this Table like so: <code>User.__table__</code></p>
<p>Note that there is no <code>__init__</code> method. declarative Base will give you a convenience <code>__init__</code> method (the constructor method) that takes as keyword arguments all names in the User class like id, name and fullname</p>
<p>The Mapper object mediates the relationship between User and the “user” Table object. User.<code>__mapper__</code>
The mapper is a sqlalchemy object that represents the linkage of a Class to a Table. It has all kinds of info stored in it about how this linkage is configured. It has a lot of informational methods. Normally we don’t need to deal with the mapper directly.</p>
<p>User has a default constructor, accepting field names as arguments.
<code>&gt;&gt;&gt;my_user = User(name='hello', fullname='World World')</code></p>
<p>Note that above we didn’t set the id field explicitly. The “id” field is the primary key, which gets automatically assigned to None if we didn’t set it explicitly. This makes sense because this object still does not represent a database row and does not exist yet in the database. Its still just a Python only object.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt;print<span style="color:#f92672">(</span>my_user.name, my_user.fullname<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>‘hello’, ‘World World’<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;print<span style="color:#f92672">(</span>my_user.id<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>None
</span></span></code></pre></div><p>“id” will have a value attached to it when the object actually gets flushed to database and database assigns the id to it. This relates to a concept called Identity Map discussed below in Identity Mapping. Until an object goes into persisted state (due to a flush to database), the identity map of that object is empty. On flush, its identity map gets filled to whatever id was generated by database.</p>
<p>Metadata object is here too, available from the Base.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; from sqlalchemy import create_engine
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; engine <span style="color:#f92672">=</span> create_engine<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sqlite:///tutorial.db&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; from sqlalchemy.ext.declarative import declarative_base
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Base <span style="color:#f92672">=</span> declarative_base<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; Base.metadata.create_all<span style="color:#f92672">(</span>engine<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><h3 id="session">Session</h3>
<p>To persist and load User Objects from the database, we use a Session object.
<code>&gt;&gt;&gt;from sqlalchemy.orm import Session</code>
<code>&gt;&gt;&gt;session = Session(bind=engine)</code>
In the core, we dealt a lot with the engine. In the ORM, we don’t deal directly with the engine. We create it and then put it in the Session object. And we don’t deal with enigne anymore. We don’t say engine.execute() or engine.connect(). We now work with a new interface called Session which is an ORM object. If you are not using the ORM, you don’t need to use a Session. So, like in core, the engine is a facade over the Python DBAPI, in the ORM the Session is a facade over the engine.</p>
<p>New objects are placed into the Session using add()
<code>&gt;&gt;&gt;my_user = User(name='hello', fullname='World World')</code>
The object my_user is now called a transient object as it has not yet been added to a session.
<code>&gt;&gt;&gt;session.add(my_user)</code>
The object my_user is now called a pending object as it has been added to a session and awaiting a flush to the database.</p>
<p>Note that lazy loading pattern is extensively used in ORM. Because of this, the Session will flush pending objects to the database before each Query.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; my_user <span style="color:#f92672">=</span> User<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;pond&#34;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;james pond&#34;</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; session.add<span style="color:#f92672">(</span>my_user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; existing_user <span style="color:#f92672">=</span> session.query<span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>.filter_by<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;john&#39;</span><span style="color:#f92672">)</span>.first<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-17 10:54:05,391 INFO sqlalchemy.engine.base.Engine INSERT INTO user <span style="color:#f92672">(</span>name, fullname<span style="color:#f92672">)</span> VALUES <span style="color:#f92672">(</span>?, ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 10:54:05,391 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;pond&#39;</span>, <span style="color:#e6db74">&#39;james pond&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 10:54:05,392 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.name <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span> LIMIT ? OFFSET ?
</span></span><span style="display:flex;"><span>2020-04-17 10:54:05,392 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john&#39;</span>, 1, 0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; existing_user
</span></span><span style="display:flex;"><span>&lt;one.User object at 0x7f929dbbf790&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>existing_user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Here, when you added a new user to session, there was no connection made to the database. my_user was still sitting in ORM as pending object. The first time a connection was made was when the first query was made. This caused a flush of all pending objects, before the execution of the query. Also, by default, this entire process of flushing and executing the query happens inside transaction. It can be changed, but this is the default.</p>
<p><strong>Cool fact</strong>: <code>query = session.query(User).filter_by(name='john')</code> is just a query object. To make it execute, you need to put a <code>.all()</code>, <code>.first()</code> etc after it. The problem with this is that it will put the entire result set in memory. You can also lazy execute it like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> query:
</span></span><span style="display:flex;"><span>    print(row)
</span></span></code></pre></div><p>here the for-in acts as a context manager and gets one row at a time.</p>
<h3 id="identity-mapping">Identity Mapping</h3>
<p>The Session maintains a unique object per identity. So, in the code below, my_user and existing_user are the same object.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; my_user <span style="color:#f92672">=</span> User<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;spam&#34;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mongo spam&#34;</span><span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; session.add<span style="color:#f92672">(</span>my_user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; existing_user <span style="color:#f92672">=</span> session.query<span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>.filter_by<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;spam&#39;</span><span style="color:#f92672">)</span>.first<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-17 11:12:38,713 INFO sqlalchemy.engine.base.Engine INSERT INTO user <span style="color:#f92672">(</span>name, fullname<span style="color:#f92672">)</span> VALUES <span style="color:#f92672">(</span>?, ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 11:12:38,713 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, <span style="color:#e6db74">&#39;mongo spam&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 11:12:38,715 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.name <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span> LIMIT ? OFFSET ?
</span></span><span style="display:flex;"><span>2020-04-17 11:12:38,715 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, 1, 0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>existing_user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; my_user is existing_user
</span></span><span style="display:flex;"><span>True
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Note: we used python is for equality check. We avoid == because <code>__eq__</code> operator can be overloaded where is cannot be overloaded. So this gives you the answer beyond doubt that both are indeed the same object.</p>
<p>This concept of my_user and existing_user being same is called Identity Mapping. This is a major design pattern and a standout feature of SQL Alchemy. Sql Alchemy maintains an identity map of objects flushed to the database and when you try to get a row from database, the ORM checks if the identity key of the requested object is already present in the identity map and gives you the same object instead of creating a new object and returning.</p>
<p>Note, if we create two objects with same primary key, we will only receive error when they are flushed, because it is at that point all constraint checking is done.</p>
<p>Also, if you notice, flush happens in one transaction. So, if a failure happens anywhere, whole transaction will be rolledback. If we wish to avoid this, we can create Safe Points and transaction will only be rolled back to that point (given error happened after safe-point).</p>
<p>Here we add multiple objects to be pending for flush. Just call <code>add_all()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.add_all<span style="color:#f92672">([</span>
</span></span><span style="display:flex;"><span>...     User<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;spam&#34;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mongo spam I&#34;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>...     User<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;spam&#34;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mongo spam II&#34;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>...     User<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;spam&#34;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mongo spam III&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Now let’s modify my_user from previous step. This is an existing persistent object (meaning it has been flushed to the database). So now my_user is marked as dirty. Objects that are dirty means those objects have had some state changed.
<code>&gt;&gt;&gt;my_user.fullname = &quot;mongo spam IV&quot;</code></p>
<p>At this point nothing has happened. No flush has been made. This is a good point to look at the session. We list all session objects that are in dirty state. Objects that are dirty means those objects have had some state changed. These objects mostly trigger an UPDATE statement. However, if there is no net change in values, then there will be no UPDATE statement.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.dirty
</span></span><span style="display:flex;"><span>IdentitySet<span style="color:#f92672">([</span>&lt;one.User object at 0x7f929e4450d0&gt;<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> elem in session.dirty:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>elem<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam IV<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Note: If we had this instead:
<code>&gt;&gt;&gt;my_user.fullname = &quot;mongo spam&quot;</code>
this would have still put the my_user object in dirty state, but there would have been no UPDATE issues during flush because ORM checks if there has been a net change in value before issuing an UPDATE statement.</p>
<p>So, objects that are pending for UPDATE, will be in the dirty list.</p>
<p>We can also get session to tell us objects which are pending (meaning they are not dirty, because these are new objects for which there is no identity map yet) through session.new().</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> elem in session.new:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>elem<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam I<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam II<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam III<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Then we do this:
<code>session.commit()</code></p>
<p>The whole transaction is now committed. Commit always triggers a final flush of remaining changes.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.commit<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:03:04,019 INFO sqlalchemy.engine.base.Engine UPDATE user SET fullname<span style="color:#f92672">=</span>? WHERE user.id <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-17 13:03:04,019 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;mongo spam IV&#39;</span>, 7<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:03:04,020 INFO sqlalchemy.engine.base.Engine INSERT INTO user <span style="color:#f92672">(</span>name, fullname<span style="color:#f92672">)</span> VALUES <span style="color:#f92672">(</span>?, ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:03:04,020 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, <span style="color:#e6db74">&#39;mongo spam I&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:03:04,021 INFO sqlalchemy.engine.base.Engine INSERT INTO user <span style="color:#f92672">(</span>name, fullname<span style="color:#f92672">)</span> VALUES <span style="color:#f92672">(</span>?, ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:03:04,021 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, <span style="color:#e6db74">&#39;mongo spam II&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:03:04,021 INFO sqlalchemy.engine.base.Engine INSERT INTO user <span style="color:#f92672">(</span>name, fullname<span style="color:#f92672">)</span> VALUES <span style="color:#f92672">(</span>?, ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:03:04,021 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, <span style="color:#e6db74">&#39;mongo spam III&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:03:04,022 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>We saw before that a flush occurs before a query. Flush will also occur right before we commit (session.commit()). This flush will be within the scope of the commit. So, it will first issue UPDATE, then INSERT the three rows and then COMMIT the transaction.</p>
<p>This is the first part of unit of work.</p>
<p>We can also use something called bulk_save_objects like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>c1 <span style="color:#f92672">=</span> User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;spam&#34;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mongo spam I&#34;</span>)
</span></span><span style="display:flex;"><span>c2 <span style="color:#f92672">=</span> User(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;spam&#34;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;mongo spam II&#34;</span>)
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">.</span>bulk_save_objects([c1,c2])
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">.</span>commit()
</span></span></code></pre></div><p>This will also flush a group of models objects to database. But the difference here is that neither c11 nor c2 were added to the session. So, if after committing, you tried to check any attributes of c1 or c2, you will get nothing. Because they were not added to the Session, their state was invalidated upon commit and was never refreshed as they are not in the session. Doing like this does give a major speed boost if objects are many million, but downside is that you cannot further work with these objects as they are not in session. Also, their state is not refreshed if there are changes to the database. Their related data is also not altered since foreign key checks are only signaled if they are in session. Also, no events will be triggered. Sqlalchemy has many hooks like commit, pre_commit hooks, but bulk_save_objects will not trigger any of them.</p>
<p>Also, note that when it is committing multiple rows, it will also try to sort out the dependencies among the rows. It will first check if there are foreign key dependencies among the committed rows and will create a topological sort based on dependencies and then commit based on that order. It will also group commits based on tables, so all commits in one table happen one after another. Hence the order in which the rows actually get inserted into the database might be different from the way they are inserted via session.add().</p>
<p>Note: INSERT and UPDATE happen before DELETE. The exception is when you want to delete and then insert a row in the same primary key location of existing row. Then the DELETE for that row will execute before the INSERT. This default behavior can be modified though.</p>
<p>After a commit, there is no transaction. Once, the session.commit() is called, the Session forgets all about the current transaction that it just committed. The Session invalidates all data, so that accessing them will automatically start a new transaction and reload from the database.</p>
<p>This makes sense as the transaction just committed would have changed the state of database and only by running a transaction and fetching values again can we know what the current data is. So, what sqlalchemy does is between two transactions, it expires/invalidates all the data. Please note that we still have all the Python objects that we made, but their guts are emptied out. Basically, the context of their attributes are emptied and they have all been affixed with a pattern called expired, i.e. their guts have all been labelled as expired.</p>
<p>If you try to access any attribute of a persistent object, like my_user above, the session will awake again, begin a new transaction and then resuscitate the my_user object and load its contents again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>my_user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:36:00,565 INFO sqlalchemy.engine.base.Engine BEGIN <span style="color:#f92672">(</span>implicit<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 13:36:00,566 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.id <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-17 13:36:00,566 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span>7,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam IV<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>The print of my_user initiated a select query to load its contents before printing them. This is because we did a session.commit() just before this print, so contents of my_user were emptied and invalidated. They had to be loaded again from database.</p>
<p>Note: This expire on commit default behavior can be turned off. So, now the data will not be invalidated on a commit. This might be useful in some scenarios as it can decrease hits to database but increases risk of getting stale data.</p>
<p>Let’s drive this concept futher.</p>
<p>We make another “dirty” change and then one “pending” change, that we might change our minds about by issuing a rollback</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; my_user.fullname <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mongo spam V&#34;</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; another_user <span style="color:#f92672">=</span> User<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Mickey&#34;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Mickey Mouse&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; session.add<span style="color:#f92672">(</span>another_user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; session.query<span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>.filter<span style="color:#f92672">(</span>User.name.in_<span style="color:#f92672">([</span><span style="color:#e6db74">&#39;spam&#39;</span>, <span style="color:#e6db74">&#39;Mickey&#39;</span><span style="color:#f92672">]))</span>.all<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-17 14:25:50,273 INFO sqlalchemy.engine.base.Engine UPDATE user SET fullname<span style="color:#f92672">=</span>? WHERE user.id <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-17 14:25:50,273 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;mongo spam V&#39;</span>, 7<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 14:25:50,274 INFO sqlalchemy.engine.base.Engine INSERT INTO user <span style="color:#f92672">(</span>name, fullname<span style="color:#f92672">)</span> VALUES <span style="color:#f92672">(</span>?, ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 14:25:50,274 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;Mickey&#39;</span>, <span style="color:#e6db74">&#39;Mickey Mouse&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 14:25:50,275 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.name IN <span style="color:#f92672">(</span>?, ?<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 14:25:50,275 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, <span style="color:#e6db74">&#39;Mickey&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>&lt;one.User object at 0x7f929e4450d0&gt;, &lt;one.User object at 0x7f929dbbf5e0&gt;, &lt;one.User object at 0x7f929dbbfee0&gt;, &lt;one.User object at 0x7f929dc699d0&gt;, &lt;one.User object at 0x7f929de0f8e0&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>NOTE: <strong>There has been a flush to the database but there has been no commit</strong>. You will not see any COMMIT anywhere in the generated SQL. Hence, if we so wished, we can issue a rollback() to undo these changes. This is still a pending transaction. So, let’s undo by doing rollback()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.rollback<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-17 14:31:31,267 INFO sqlalchemy.engine.base.Engine ROLLBACK
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>This ROLLBACK will also end the current transaction, exactly like session.commit() also ends the current transaction.</p>
<p>If we try to now do my_user.fullname, it will again initiate a query to database. This makes sense because we just did a rollback and this changed the state of database again (rollback discarded all the database updates/writes done by the transaction.. this undoing is also a state change). So we fetch data again from database for the query.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; my_user.fullname
</span></span><span style="display:flex;"><span>2020-04-17 14:56:22,451 INFO sqlalchemy.engine.base.Engine BEGIN <span style="color:#f92672">(</span>implicit<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-17 14:56:22,452 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.id <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-17 14:56:22,452 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span>7,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;mongo spam IV&#39;</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>We see that the fullname is back to what it was. The change we did has been discarded. The pending object another_user has been evicted from session.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; another_user in session
</span></span><span style="display:flex;"><span>False
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>In other words, objects like my_user are really a proxy for a row in database. This proxy object only has valid object when it is inside of a transaction. When a transaction ends, the contents of this proxy object are invalidated and sql alchemy has no idea what that data is. If we tried to query the proxy object again, it will have to start a new transaction and fetch the row it corresponds to, to populate itself.</p>
<h3 id="orm-querying">ORM Querying</h3>
<p>The attributes on our mapped class act like Column objects, and produce SQL expressions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>User.name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;john&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;user&#34;</span>.name <span style="color:#f92672">=</span> :name_1
</span></span><span style="display:flex;"><span>&gt;&gt;
</span></span></code></pre></div><p>Caveat here is that the object User.name is not actually a Column but acts like a column (its actually InstrumentedAttribute):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; User.name
</span></span><span style="display:flex;"><span>&lt;sqlalchemy.orm.attributes.InstrumentedAttribute object at 0x7f929dc0bef0&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Also, this “pseudo Column” acts like a ClauseElement. What this means is that it can be used in pattern matching in .like() clause like so:
<code>query = session.query(User).filter(User.fullname.like('%john%')).first()</code>
This will return the first user whose full name has john in it.</p>
<p>There are lot of other ClauseElement methods like:between(cleft,cright), distinct(), in_([list]), is_(None), contains(&lsquo;string&rsquo;), endswith(&lsquo;string&rsquo;), startswith(&lsquo;string&rsquo;), ilike(&lsquo;string&rsquo;)</p>
<p>Another note about .query() is that it acts a lot like the core .select() except that .query() gives a lot more functionality. Like here we are selecting the User entity</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; query <span style="color:#f92672">=</span> session.query<span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>.filter<span style="color:#f92672">(</span>User.name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;spam&#39;</span><span style="color:#f92672">)</span>.order_by<span style="color:#f92672">(</span>User.id<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; query.all<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-17 16:41:40,420 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.name <span style="color:#f92672">=</span> ? ORDER BY user.id
</span></span><span style="display:flex;"><span>2020-04-17 16:41:40,420 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>&lt;one.User object at 0x7f929e4450d0&gt;, &lt;one.User object at 0x7f929dbbfc40&gt;, &lt;one.User object at 0x7f929dbbfac0&gt;, &lt;one.User object at 0x7f929dc699d0&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> user in query.all<span style="color:#f92672">()</span>:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span>2020-04-17 16:42:17,499 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.name <span style="color:#f92672">=</span> ? ORDER BY user.id
</span></span><span style="display:flex;"><span>2020-04-17 16:42:17,499 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam IV<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam I<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam II<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam III<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Note: instead of saying conn.execute(), the query has all the execution methods in it. So, saying query.all() actually executes the query and fetches all the required items. Also, unlike in core.select(), where we got tuple objects back, we now get User objects back.</p>
<p>Query can also return individual columns.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> name,fullname in session.query<span style="color:#f92672">(</span>User.name, User.fullname<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>name,fullname<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span>2020-04-17 16:49:02,615 INFO sqlalchemy.engine.base.Engine SELECT user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user
</span></span><span style="display:flex;"><span>2020-04-17 16:49:02,615 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>john john galt
</span></span><span style="display:flex;"><span>ding ding dong
</span></span><span style="display:flex;"><span>bond james bond
</span></span><span style="display:flex;"><span>pond james pond
</span></span><span style="display:flex;"><span>pond james pond
</span></span><span style="display:flex;"><span>pond james pond
</span></span><span style="display:flex;"><span>spam mongo spam IV
</span></span><span style="display:flex;"><span>spam mongo spam I
</span></span><span style="display:flex;"><span>spam mongo spam II
</span></span><span style="display:flex;"><span>spam mongo spam III
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Note that each row is returned as a sort of a named-tuple. It is actually a KeyedTuple but it acts like a named-tuple in the sense that tuple values can be accessed by their column names.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; row <span style="color:#f92672">=</span> session.query<span style="color:#f92672">(</span>User.name, User.fullname<span style="color:#f92672">)</span>.first<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-17 16:54:50,917 INFO sqlalchemy.engine.base.Engine SELECT user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user
</span></span><span style="display:flex;"><span> LIMIT ? OFFSET ?
</span></span><span style="display:flex;"><span>2020-04-17 16:54:50,917 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span>1, 0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; row.name
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;john&#39;</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; row.fullname
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;john galt&#39;</span>
</span></span></code></pre></div><p>You can also mix entities and columns together</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> row in session.query<span style="color:#f92672">(</span>User, User.id, User.name<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>row.User, row.id, row.name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span>2020-04-17 17:02:12,951 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user
</span></span><span style="display:flex;"><span>2020-04-17 17:02:12,951 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">1</span> john
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>ding, ding dong<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">2</span> ding
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>bond, james bond<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">3</span> bond
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>pond, james pond<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">4</span> pond
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>pond, james pond<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">5</span> pond
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>pond, james pond<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">6</span> pond
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam IV<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">7</span> spam
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam I<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">8</span> spam
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam II<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">9</span> spam
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>spam, mongo spam III<span style="color:#f92672">)</span>&gt; <span style="color:#ae81ff">10</span> spam
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>So, here we queried for an entity and a column at the same time and we get them back as a list of named-tuples like objects.</p>
<p>This feature of mixed entity and column helps us do this cool thing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; d <span style="color:#f92672">=</span> dict<span style="color:#f92672">(</span>session.query<span style="color:#f92672">(</span>User.id,User<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>2020-04-17 17:05:52,838 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user
</span></span><span style="display:flex;"><span>2020-04-17 17:05:52,838 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; d
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>1: &lt;one.User object at 0x7f929dbbf790&gt;, 2: &lt;one.User object at 0x7f929dbbfb80&gt;, 3: &lt;one.User object at 0x7f929dbbfc40&gt;, 4: &lt;one.User object at 0x7f929dbe4070&gt;, 5: &lt;one.User object at 0x7f929dbe40a0&gt;, 6: &lt;one.User object at 0x7f929dbe4190&gt;, 7: &lt;one.User object at 0x7f929e4450d0&gt;, 8: &lt;one.User object at 0x7f929dbe41c0&gt;, 9: &lt;one.User object at 0x7f929dbe4250&gt;, 10: &lt;one.User object at 0x7f929dc699d0&gt;<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Here we got a dict of all users with their id as keys for dict.</p>
<p>Also, array indexes will OFFSET to that index and LIMIT by one</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; u <span style="color:#f92672">=</span> session.query<span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>.order_by<span style="color:#f92672">(</span>User.id<span style="color:#f92672">)[</span>2<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>2020-04-17 20:12:25,606 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user ORDER BY user.id
</span></span><span style="display:flex;"><span> LIMIT ? OFFSET ?
</span></span><span style="display:flex;"><span>2020-04-17 20:12:25,607 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span>1, 2<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>u<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>bond, james bond<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;{u.id} : {u}&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> : &lt;User<span style="color:#f92672">(</span>bond, james bond<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Notice that LIMIT is 1 and OFFSET is 2 (meaning it returns the third element)</p>
<p>For array slice too, its similar</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; u <span style="color:#f92672">=</span> session.query<span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>.order_by<span style="color:#f92672">(</span>User.id<span style="color:#f92672">)[</span>1:3<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>2020-04-17 20:15:59,815 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user ORDER BY user.id
</span></span><span style="display:flex;"><span> LIMIT ? OFFSET ?
</span></span><span style="display:flex;"><span>2020-04-17 20:15:59,815 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span>2, 1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> elem in u:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;{elem.id} : {elem}&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span> : &lt;User<span style="color:#f92672">(</span>ding, ding dong<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span> : &lt;User<span style="color:#f92672">(</span>bond, james bond<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>This won’t work if array indices are -ve because -ve array slice has no meaning in this context</p>
<p>the WHERE clause is either filter_by(), which is convenient (note that you don’t need to say User.fullname):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> name, in session.query<span style="color:#f92672">(</span>User.name<span style="color:#f92672">)</span>.filter_by<span style="color:#f92672">(</span>fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;name is: {name}&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span>2020-04-17 20:22:33,826 INFO sqlalchemy.engine.base.Engine SELECT user.name AS user_name 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.fullname <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-17 20:22:33,826 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john galt&#39;</span>,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>name is: john
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>where .filter() is the full-blown expression:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> name, in session.query<span style="color:#f92672">(</span>User.name<span style="color:#f92672">)</span>.filter<span style="color:#f92672">(</span>User.fullname<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;name is: {name}&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span>2020-04-17 20:24:34,791 INFO sqlalchemy.engine.base.Engine SELECT user.name AS user_name 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE user.fullname <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-17 20:24:34,791 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john galt&#39;</span>,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>name is: john
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>conjunctions can be passed to filter() as well:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> or_
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> name, <span style="color:#f92672">in</span> session<span style="color:#f92672">.</span>query(User<span style="color:#f92672">.</span>name)<span style="color:#f92672">.</span>filter(or_(User<span style="color:#f92672">.</span>name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;john&#39;</span>, User<span style="color:#f92672">.</span>id <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>)):
</span></span><span style="display:flex;"><span>    print(name)
</span></span></code></pre></div><p>you can method chain multiple filter to do AND in the WHERE clause</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; <span style="color:#66d9ef">for</span> name, in session.query<span style="color:#f92672">(</span>User.name<span style="color:#f92672">)</span>.filter<span style="color:#f92672">(</span>or_<span style="color:#f92672">(</span>User.name<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;john&#39;</span>, User.id &lt; 5<span style="color:#f92672">))</span>.filter<span style="color:#f92672">(</span>User.fullname<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>...     print<span style="color:#f92672">(</span>name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... 
</span></span><span style="display:flex;"><span>2020-04-17 21:03:42,319 INFO sqlalchemy.engine.base.Engine SELECT user.name AS user_name 
</span></span><span style="display:flex;"><span>FROM user 
</span></span><span style="display:flex;"><span>WHERE <span style="color:#f92672">(</span>user.name <span style="color:#f92672">=</span> ? OR user.id &lt; ?<span style="color:#f92672">)</span> AND user.fullname <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-17 21:03:42,319 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;john&#39;</span>, 5, <span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>john
</span></span></code></pre></div><p>.query() has some variations like:
session.query(User).all() which will return all the rows in User. If we use session.query(User).first(), it will generate the SQL with LIMIT set to 1. This is an optimization so that the DBAPI does not load the entire table. There is one more variant of .first() called .one()</p>
<p>The specialty of query.one() is that it will return the first row and verifies that there’s one and only one.</p>
<p>This is really hand when we are querying for something unique, for which there should be only one value returned. If multiple values are returned, it will throw an exception.</p>
<p>If you query.one() for a row that does not exist, you will get an exception that NoResultFound.</p>
<p>If you query.one() for a row and multiple rows are found, you will get an exception that MultipleResultsFound.</p>
<p>So, for all the cases where you know that you need to get one and only one row, use query.one()</p>
<h2 id="advanced-orm">Advanced ORM</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> relationship
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.ext.declarative <span style="color:#f92672">import</span> declarative_base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine <span style="color:#f92672">=</span> create_engine(<span style="color:#e6db74">&#34;sqlite:///tutorial.db&#34;</span>)
</span></span><span style="display:flex;"><span>Base <span style="color:#f92672">=</span> declarative_base()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">User</span>(Base):
</span></span><span style="display:flex;"><span>    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;user&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Column(sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    name <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Column(sa<span style="color:#f92672">.</span>String)
</span></span><span style="display:flex;"><span>    fullname <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Column(sa<span style="color:#f92672">.</span>String)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __repr__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&lt;User(</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>fullname<span style="color:#e6db74">}</span><span style="color:#e6db74">)&gt;&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __str__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&lt;User(</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">, </span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>fullname<span style="color:#e6db74">}</span><span style="color:#e6db74">)&gt;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Address</span>(Base):
</span></span><span style="display:flex;"><span>    __tablename__ <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;address&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    id <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Column(sa<span style="color:#f92672">.</span>Integer, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    email_address <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Column(sa<span style="color:#f92672">.</span>String, nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    user_id <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Column(sa<span style="color:#f92672">.</span>Integer, sa<span style="color:#f92672">.</span>ForeignKey(<span style="color:#e6db74">&#39;user.id&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    user <span style="color:#f92672">=</span> relationship(<span style="color:#e6db74">&#39;User&#39;</span>, backref<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;addresses&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __repr__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;&lt;Address(</span><span style="color:#e6db74">{</span>self<span style="color:#f92672">.</span>email_address<span style="color:#e6db74">}</span><span style="color:#e6db74">)&gt;&#39;</span>
</span></span></code></pre></div><p>In the above code, User class is familiar. We have added another class called Address. This class is dependent on User via foreign-key relationship. The logic is that every user can have 0 or more addresses associated to him. That is every user in our database will have a list of addresses associated to him.</p>
<p>Notice, the verbose way in which this relationship is described.
<code>user_id = sa.Column(sa.Integer, sa.ForeignKey('user.id')) </code>
is the foreign key column in Address. It specifies that Address will have a foreign key column called user_id which will reference id field in user table of the database. This is the forward reference.</p>
<p>The other side of the foreign key reference, the backward-reference is also specified in the same dependent Address class. This is in this line:
<code>user = relationship('User', backref='addresses')</code>
Notice, this is not a Column. This is instead an attribute Address class. This user attribute in Address class specifies the relationship to the User class. It has a directive called backref. What this means is that User class will have a collection of addresses attached to it. So, you’ll have Address.user and User.addresses</p>
<p>Hence Address.user will point to the User entity related to the address object. User.addresses will be the list of Address entities related to the User.</p>
<p>So, we have here, in a very verbose way, described:</p>
<ul>
<li>How the two classes are related (via the <code>user = relationship('User', backref='addresses')</code>)</li>
</ul>
<p>separately from</p>
<ul>
<li>How the two database tables are related (via <code>user_id = sa.Column(sa.Integer, sa.ForeignKey('user.id')</code>)</li>
</ul>
<p>SqlAlchemy also does not assume that a database model will have a primary key called id and it will be integer. This makes it verbose, but by default, that is how it is. You can automate primary-key creation using mixins but by default, it is verbose and you have to explicitly specify your primary key.</p>
<p>So, lets create all tables by calling Base.metadata.create_all(engine). This will check if a table exists. If it does, creation is ignored, if it does not, it is created.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; Base.metadata.create_all<span style="color:#f92672">(</span>engine<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-18 07:24:52,636 INFO sqlalchemy.engine.base.Engine PRAGMA main.table_info<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-18 07:24:52,636 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 07:24:52,637 INFO sqlalchemy.engine.base.Engine PRAGMA main.table_info<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-18 07:24:52,637 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 07:24:52,637 INFO sqlalchemy.engine.base.Engine PRAGMA temp.table_info<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;address&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-18 07:24:52,637 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 07:24:52,638 INFO sqlalchemy.engine.base.Engine 
</span></span><span style="display:flex;"><span>CREATE TABLE address <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        id INTEGER NOT NULL, 
</span></span><span style="display:flex;"><span>        email_address VARCHAR NOT NULL, 
</span></span><span style="display:flex;"><span>        user_id INTEGER, 
</span></span><span style="display:flex;"><span>        PRIMARY KEY <span style="color:#f92672">(</span>id<span style="color:#f92672">)</span>, 
</span></span><span style="display:flex;"><span>        FOREIGN KEY<span style="color:#f92672">(</span>user_id<span style="color:#f92672">)</span> REFERENCES user <span style="color:#f92672">(</span>id<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>2020-04-18 07:24:52,638 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 07:24:52,806 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>If you will list any user in the User table, you will see that now that user has gained an empty “addresses” collection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; john_galt <span style="color:#f92672">=</span> session.query<span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>.filter_by<span style="color:#f92672">(</span>fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;john galt&#39;</span><span style="color:#f92672">)</span>.first<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; john_galt
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; john_galt.addresses
</span></span><span style="display:flex;"><span><span style="color:#f92672">[]</span>
</span></span></code></pre></div><p>Lets add some addresses to ‘john galt’:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; john_galt.addresses <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>... Address<span style="color:#f92672">(</span>email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;john@j.com&#39;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>... Address<span style="color:#f92672">(</span>email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;galt@john.com&#39;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>... Address<span style="color:#f92672">(</span>email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;john_galt@galt.com&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; session.dirty
</span></span><span style="display:flex;"><span>IdentitySet<span style="color:#f92672">([</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>.addresses is a python list. So, you can use the regular python methods like .append() to add items to the list.</p>
<p>Also, whenever you add an item to the list addresses associated with a User entity, an append event gets fired and that newly added Address entity automatically also gets set a foreign key reference to the User entity. You can actually catch these events. There are similar events for all sorts of features.</p>
<p>We will now see a feature of sqlalchemy called Save-Update cascade.</p>
<p>We create a transient User entity and attach addresses to it. In this case new_user. We only add this entity to the session. When we do session.new, we see that related Address entities have been added to the session as well. This is save-update cascade. Meaning that you have this object that you added to the Session. Then sqlalchemy will traverse all other objects that are mapped to the newly added object and add them to the session. This is done recursively so if this map is multiple hierarchies with object related to another which is related to another, they all get added to the session. So, if you have a bunch of objects, with one lead object, like the document object, you just add this document object and the rest of the mapped objects just cascade in. All these cascaded objects will be in pending state and upon a flush, they will all be inserted into the database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; new_user <span style="color:#f92672">=</span> User<span style="color:#f92672">(</span>name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;reese&#34;</span>, fullname<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;m reese&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; new_user.addresses
</span></span><span style="display:flex;"><span><span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; new_user.addresses<span style="color:#f92672">=[</span>
</span></span><span style="display:flex;"><span>... Address<span style="color:#f92672">(</span>email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;m@m.com&#39;</span><span style="color:#f92672">)</span>,
</span></span><span style="display:flex;"><span>... Address<span style="color:#f92672">(</span>email_address<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;m.reese@r.com&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>... <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; session.add<span style="color:#f92672">(</span>new_user<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; session.new
</span></span><span style="display:flex;"><span>IdentitySet<span style="color:#f92672">([</span>&lt;Address<span style="color:#f92672">(</span>john@j.com<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>galt@john.com<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john_galt@galt.com<span style="color:#f92672">)</span>&gt;, &lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m@m.com<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m.reese@r.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">])</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Finally do session.commit() to commit everything in one shot.</p>
<p>Note that here, we never specified primary keys for any of the Address entites that got added. ORM took care of auto-incrementing them when adding to the database.
So, you can see the time saved here. ORMs really shine on the persistence side. You just added one lead object to the session and called session.commit() and ORM took care of the rest. It really saved you a lot of time otherwise spent in manually saving everything to database, manually setting the foreign-key relationships for each new update etc.</p>
<p>Now, since the transaction got committed, new_user.addresses will actually start a new transaction and read from the database again. But until his transaction ends, these addresses are cached in memory. If you did new_user.addresses again within the same transaction, the cached values will be returned.</p>
<p>In a web application, within a request, its generally good to call session.close(). This will automatically result in a rollback, so you don’t have to. This is when during the request, we did only select queries. There is nothing to commit. So, rollback won’t cause any state change in the database. This is because connections are pooled and when we put the connection back in the pool, we want to ensure rollback was called before because connection can have state in it. If the connection wasn’t committed, it can have locks on tables that you want to rollback. So, when you send the connection back to pool, at the very least it has to roll back or you commit it.</p>
<p>Collections and references are updated by manipulating objects, not primary/foreign keys. Let’s see an example.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; john_galt.addresses
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>&lt;Address<span style="color:#f92672">(</span>john@j.com<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>galt@john.com<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john_galt@galt.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; new_user.addresses
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>&lt;Address<span style="color:#f92672">(</span>m@m.com<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m.reese@r.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Here we have two user objects with their collections of addresses. We now want to assign one of the addresses of john_galt to new_user. We can do this by directly changing the foreign key field (user_id) but then sqlalchemy won’t be able to update the addresses collection of both the users. Instead we do it like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; john_galt.addresses<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&lt;Address<span style="color:#f92672">(</span>john_galt@galt.com<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; john_galt.addresses<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>.user
</span></span><span style="display:flex;"><span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; john_galt.addresses<span style="color:#f92672">[</span>2<span style="color:#f92672">]</span>.user <span style="color:#f92672">=</span> new_user
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; new_user.addresses
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>&lt;Address<span style="color:#f92672">(</span>m@m.com<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m.reese@r.com<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john_galt@galt.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; john_galt.addresses
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>&lt;Address<span style="color:#f92672">(</span>john@j.com<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>galt@john.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>The key part is this:
<code>&gt;&gt;&gt; john_galt.addresses[2].user = new_user</code>
This is what causes the change and now the objects are updated properly.</p>
<p>Now we do commit and all the foreign keys are automatically set.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.commit<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 10:10:24,362 INFO sqlalchemy.engine.base.Engine UPDATE address SET user_id<span style="color:#f92672">=</span>? WHERE address.id <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-18 10:10:24,362 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span>11, 3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-18 10:10:24,363 INFO sqlalchemy.engine.base.Engine COMMIT
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>So, you could have worked both ways but sqlalchemy is opinionated and it wants you to work in that direction.</p>
<h2 id="joins">Joins</h2>
<h4 id="implicit-joins">Implicit Joins</h4>
<p>Query can select from multiple tables at once. Below is an implicit join. (implicit means that term JOIN is not present in the generated SQL)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.query<span style="color:#f92672">(</span>User,Address<span style="color:#f92672">)</span>.filter<span style="color:#f92672">(</span>User.id<span style="color:#f92672">==</span>Address.user_id<span style="color:#f92672">)</span>.all<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 10:31:21,001 INFO sqlalchemy.engine.base.Engine BEGIN <span style="color:#f92672">(</span>implicit<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-18 10:31:21,002 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname, address.id AS address_id, address.email_address AS address_email_address, address.user_id AS address_user_id 
</span></span><span style="display:flex;"><span>FROM user, address 
</span></span><span style="display:flex;"><span>WHERE user.id <span style="color:#f92672">=</span> address.user_id
</span></span><span style="display:flex;"><span>2020-04-18 10:31:21,002 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john@j.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>galt@john.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john_galt@galt.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m@m.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m.reese@r.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>Notice the <code>WHERE user.id = address.user_id</code> line in the generated SQL. This is what creates an implicit join. If we didn’t have this, we would have simply received a cartesian product of the two tables.</p>
<h4 id="explicit-joins">Explicit Joins</h4>
<p>join() is used to create an explicit JOIN.</p>
<p><strong>BAD WAY first</strong>. This is very error prone:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.query<span style="color:#f92672">(</span>User, Address<span style="color:#f92672">)</span>.join<span style="color:#f92672">(</span>Address<span style="color:#f92672">)</span>.all<span style="color:#f92672">()</span>2020-04-18 11:15:52,172 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname, address.id AS address_id, address.email_address AS address_email_address, address.user_id AS address_user_id 
</span></span><span style="display:flex;"><span>FROM user JOIN address ON user.id <span style="color:#f92672">=</span> address.user_id
</span></span><span style="display:flex;"><span>2020-04-18 11:15:52,173 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john@j.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>galt@john.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john_galt@galt.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m@m.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m.reese@r.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; 
</span></span></code></pre></div><p>This approach will only work for simple joins. Very error prone. Avoid. This will only give the right result when there is no ambiguity in joining the two tables with just table names provided. If there is any ambiguity involved, and requires further detail specification on how to join, it will return bad results.</p>
<p><strong>BETTER WAY</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.query<span style="color:#f92672">(</span>User,Address<span style="color:#f92672">)</span>.join<span style="color:#f92672">(</span>Address, User.id<span style="color:#f92672">==</span>Address.user_id<span style="color:#f92672">)</span>.all<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 10:45:14,563 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname, address.id AS address_id, address.email_address AS address_email_address, address.user_id AS address_user_id 
</span></span><span style="display:flex;"><span>FROM user JOIN address ON user.id <span style="color:#f92672">=</span> address.user_id
</span></span><span style="display:flex;"><span>2020-04-18 10:45:14,563 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john@j.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>galt@john.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john_galt@galt.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m@m.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m.reese@r.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Note, there is a convention here: join will by default look at the first entry in this list session.query(User,Address), which is User. And this will be the left side of the JOIN. Notice the line FROM user JOIN address in generated SQL. user is on left side of JOIN.</p>
<p><strong>BEST WAY</strong>:
The most succinct and accurate way to join() is to use the relationship()-bound attribute to specify ON.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.query<span style="color:#f92672">(</span>User, Address<span style="color:#f92672">)</span>.join<span style="color:#f92672">(</span>User.addresses<span style="color:#f92672">)</span>.all<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 11:12:41,633 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname, address.id AS address_id, address.email_address AS address_email_address, address.user_id AS address_user_id 
</span></span><span style="display:flex;"><span>FROM user JOIN address ON user.id <span style="color:#f92672">=</span> address.user_id
</span></span><span style="display:flex;"><span>2020-04-18 11:12:41,633 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john@j.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>galt@john.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john_galt@galt.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m@m.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m.reese@r.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Inside a join query, either User or Address may be referred to anywhere in the query.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.query<span style="color:#f92672">(</span>User, Address<span style="color:#f92672">)</span>.join<span style="color:#f92672">(</span>User.addresses<span style="color:#f92672">)</span>.filter<span style="color:#f92672">(</span>Address.email_address<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;m@m.com&#39;</span><span style="color:#f92672">)</span>.first<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 11:23:20,132 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname, address.id AS address_id, address.email_address AS address_email_address, address.user_id AS address_user_id 
</span></span><span style="display:flex;"><span>FROM user JOIN address ON user.id <span style="color:#f92672">=</span> address.user_id 
</span></span><span style="display:flex;"><span>WHERE address.email_address <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span> LIMIT ? OFFSET ?
</span></span><span style="display:flex;"><span>2020-04-18 11:23:20,132 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;m@m.com&#39;</span>, 1, 0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m@m.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>If we want to break the convention of .query(User,Address), User being the left side as it is first element. We can break this convention by specifying an explicit FROM using select_from()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.query<span style="color:#f92672">(</span>User, Address<span style="color:#f92672">)</span>.select_from<span style="color:#f92672">(</span>Address<span style="color:#f92672">)</span>.join<span style="color:#f92672">(</span>Address.user<span style="color:#f92672">)</span>.all<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 11:27:36,430 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname, address.id AS address_id, address.email_address AS address_email_address, address.user_id AS address_user_id 
</span></span><span style="display:flex;"><span>FROM address JOIN user ON user.id <span style="color:#f92672">=</span> address.user_id
</span></span><span style="display:flex;"><span>2020-04-18 11:27:36,431 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john@j.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>john, john galt<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>galt@john.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>john_galt@galt.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m@m.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;, &lt;Address<span style="color:#f92672">(</span>m.reese@r.com<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Notice <code>FROM address JOIN user</code> in generated SQL. address is on left side of JOIN.</p>
<p>A query that refers to the same entity more than once in the FROM clause requires aliasing</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.query<span style="color:#f92672">(</span>User<span style="color:#f92672">)</span>.join<span style="color:#f92672">(</span>a1<span style="color:#f92672">)</span>.join<span style="color:#f92672">(</span>a2<span style="color:#f92672">)</span>.filter<span style="color:#f92672">(</span>a1.email_address <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;m.reese@r.com&#39;</span><span style="color:#f92672">)</span>.filter<span style="color:#f92672">(</span>a2.email_address<span style="color:#f92672">==</span><span style="color:#e6db74">&#39;john_galt@galt.com&#39;</span><span style="color:#f92672">)</span>.all<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 11:44:24,744 INFO sqlalchemy.engine.base.Engine SELECT user.id AS user_id, user.name AS user_name, user.fullname AS user_fullname 
</span></span><span style="display:flex;"><span>FROM user JOIN address AS address_1 ON user.id <span style="color:#f92672">=</span> address_1.user_id JOIN address AS address_2 ON user.id <span style="color:#f92672">=</span> address_2.user_id 
</span></span><span style="display:flex;"><span>WHERE address_1.email_address <span style="color:#f92672">=</span> ? AND address_2.email_address <span style="color:#f92672">=</span> ?
</span></span><span style="display:flex;"><span>2020-04-18 11:44:24,744 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;m.reese@r.com&#39;</span>, <span style="color:#e6db74">&#39;john_galt@galt.com&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>&lt;User<span style="color:#f92672">(</span>reese, m reese<span style="color:#f92672">)</span>&gt;<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Here only those users will be chosen who have both addresses ‘m.reese@r.com’ and ‘john_<a href="mailto:galt@galt.com">galt@galt.com</a>’</p>
<p>Note that we didn’t have to create aliased names like address_1 and address_2 as we see in the generated SQL. Its taken care of. We just have to create aliased objects.</p>
<p>We can also join with subqueries. subquery() returns an alias construct for us to use.</p>
<p>Here we have an example where we count the number of addresses each user has:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy <span style="color:#f92672">import</span> func
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sqlalchemy.orm <span style="color:#f92672">import</span> Session
</span></span><span style="display:flex;"><span>session <span style="color:#f92672">=</span> Session(bind<span style="color:#f92672">=</span>engine)
</span></span><span style="display:flex;"><span>subq <span style="color:#f92672">=</span> session<span style="color:#f92672">.</span>query(func<span style="color:#f92672">.</span>count(Address<span style="color:#f92672">.</span>id)<span style="color:#f92672">.</span>label(<span style="color:#e6db74">&#39;count&#39;</span>), User<span style="color:#f92672">.</span>id<span style="color:#f92672">.</span>label(<span style="color:#e6db74">&#39;user_id&#39;</span>))<span style="color:#f92672">.</span>join(Address<span style="color:#f92672">.</span>user)<span style="color:#f92672">.</span>group_by(User<span style="color:#f92672">.</span>id)<span style="color:#f92672">.</span>subquery()
</span></span><span style="display:flex;"><span><span style="color:#75715e">#session.query(User.name, func.coalesce(subq.c.count,0)).outerjoin(subq, User.id==subq.c.user_id).all()</span>
</span></span></code></pre></div><p>Note, we need to use COALESCE because we are using OUTERJOIN and we want to avoid having null.</p>
<p>Now lets load up the query in python shell and execute:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; session.query<span style="color:#f92672">(</span>User.name, func.coalesce<span style="color:#f92672">(</span>subq.c.count,0<span style="color:#f92672">))</span>.outerjoin<span style="color:#f92672">(</span>subq, User.id<span style="color:#f92672">==</span>subq.c.user_id<span style="color:#f92672">)</span>.all<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>2020-04-18 15:32:55,857 INFO sqlalchemy.engine.base.Engine BEGIN <span style="color:#f92672">(</span>implicit<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>2020-04-18 15:32:55,858 INFO sqlalchemy.engine.base.Engine SELECT user.name AS user_name, coalesce<span style="color:#f92672">(</span>anon_1.count, ?<span style="color:#f92672">)</span> AS coalesce_1 
</span></span><span style="display:flex;"><span>FROM user LEFT OUTER JOIN <span style="color:#f92672">(</span>SELECT count<span style="color:#f92672">(</span>address.id<span style="color:#f92672">)</span> AS count, user.id AS user_id 
</span></span><span style="display:flex;"><span>FROM address JOIN user ON user.id <span style="color:#f92672">=</span> address.user_id GROUP BY user.id<span style="color:#f92672">)</span> AS anon_1 ON user.id <span style="color:#f92672">=</span> anon_1.user_id
</span></span><span style="display:flex;"><span>2020-04-18 15:32:55,858 INFO sqlalchemy.engine.base.Engine <span style="color:#f92672">(</span>0,<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[(</span><span style="color:#e6db74">&#39;john&#39;</span>, 2<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;ding&#39;</span>, 0<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;bond&#39;</span>, 0<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;pond&#39;</span>, 0<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;pond&#39;</span>, 0<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;pond&#39;</span>, 0<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, 0<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, 0<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, 0<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;spam&#39;</span>, 0<span style="color:#f92672">)</span>, <span style="color:#f92672">(</span><span style="color:#e6db74">&#39;reese&#39;</span>, 3<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt;
</span></span></code></pre></div><p>Notice: .func() is a core function that lets us run any SQL function like SUM, COUNT, COALESCE etc</p>
<p>func is not a module. Its is a module generator. In sqlalchemy, func is aware what database it is connected to and will call the SQL functions native to that database.</p>
<p>.subquery() object when executed, returns a set of rows and can be used inside a query like a table. Note that query object subq is turned into a subquery by calling subquery() at the end in subq = session.query(func.count(Address.id).label(&lsquo;count&rsquo;), User.id.label(&lsquo;user_id&rsquo;)).join(Address.user).group_by(User.id).subquery()</p>
<h2 id="eager-loading">Eager Loading</h2>
<p>The N plus one problem refers to the many SELECT statements emitted when loading collections against a parent result.</p>

		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/python/" rel="tag">python</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>




			</div>
			<aside class="sidebar">
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="LinkedIn" rel="noopener noreferrer" href="https://linkedin.com/in/himanshu-singh-remote/" target="_blank">
				<svg class="widget-social__link-icon icon icon-linkedin" width="24" height="24" viewBox="0 0 352 352"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/tek-shinobi" target="_blank">
				<svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>

		
	</div>
</div>
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/posts/github_managing-multiple-accounts/">Github:managing Multiple Accounts: SSH configuration</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/linux_iptables-cheatsheet/">Linux:Iptables Cheatsheet</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/aws_setup-reverse-proxy-in-aws-using-elb/">AWS:Setup Reverse Proxy in AWS Using ELB</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/grafana_grafana-loki-aws-s3-integration/">Grafana:Grafana Loki AWS S3 Integration</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/golang_distributed-rate-limiting-using-fixed-window/">Golang: Distributed Rate Limiting Using Fixed Window and Redis</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/rate-limiting-in-distributed-system/">Rate Limiting in a Distributed System</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/golang-testing-creating-large-files/">Golang Testing: Creating Large Files</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/grafana-loki-logql-tutorial/">Grafana Loki LogQL Tutorial</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/add-gpg-keys-to-repo/">Add Gpg Keys to Repo</a></li>
			<li class="widget__item"><a class="widget__link" href="/posts/golang-handling-null-in-database-tables/">Golang: Handling Null in Database Tables</a></li>
		</ul>
	</div>
</div>
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item">
				<a class="widget__link" href="/categories/backend/">backend</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/distributed-system-design/">distributed system design</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/docker/">docker</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/frontend/">frontend</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/github/">github</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/golang/">golang</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/grafana/">grafana</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/javascript/">javascript</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/kubernetes/">kubernetes</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/linux/">Linux</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/mongodb/">mongodb</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/networking/">networking</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/python/">python</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/rust/">rust</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/study/">study</a></li>
			<li class="widget__item">
				<a class="widget__link" href="/categories/virtualbox/">Virtualbox</a></li>
		</ul>
	</div>
</div>
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/automation/" title="automation">automation</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/aws/" title="aws">aws</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/backend/" title="backend">backend</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/c#/" title="c#">c#</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/concurrency/" title="concurrency">concurrency</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/css/" title="css">css</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/django/" title="django">django</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/docker/" title="docker">docker</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/es6/" title="ES6">ES6</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/github/" title="github">github</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/golang/" title="golang">golang</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/gpg/" title="gpg">gpg</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/iptables/" title="iptables">iptables</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/javascript/" title="javascript">javascript</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/logql/" title="LogQL">LogQL</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/loki/" title="loki">loki</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/minikube/" title="minikube">minikube</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/mongodb/" title="mongodb">mongodb</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/networking/" title="networking">networking</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/postgres/" title="postgres">postgres</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/python/" title="python">python</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/rate-limiter/" title="rate limiter">rate limiter</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/react/" title="react">react</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/redis/" title="redis">redis</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/rust/" title="rust">rust</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/s3/" title="s3">s3</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/scrapy/" title="scrapy">scrapy</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/study/" title="study">study</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/tcp/" title="tcp">tcp</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/testing/" title="testing">testing</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/tools/" title="tools">tools</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/turbofish/" title="turbofish">turbofish</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/virtualbox/" title="virtualbox">virtualbox</a>
	</div>
</div>
</aside>
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 Tek Shinobi Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>